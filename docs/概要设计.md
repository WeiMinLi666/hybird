# 混合证书管理系统概要设计

**项目名称**：混合证书管理系统
**文档版本**：V1.0
**编写日期**：2025年
**密级**：内部公开

---

## 摘要

本文档是混合证书管理系统的概要设计文档，旨在为系统的开发、测试和部署提供全面的技术指导。本系统基于领域驱动设计（DDD）架构和后量子密码学技术，实现企业级数字证书的全生命周期管理。系统支持传统密码学算法（SM2、RSA、ECDSA）与后量子密码学算法（ML-DSA、ML-KEM）的混合签名，为企业提供安全、可靠、可扩展的证书管理解决方案。

本文档从系统概述、架构设计、领域模型设计、功能设计、数据库设计、接口设计、非功能需求、定时任务设计、缓存策略、部署架构等方面对系统进行了全面阐述，为后续的详细设计和开发实施奠定了基础。

**关键词**：混合证书；后量子密码学；领域驱动设计；证书管理系统；SM2算法

---

## 第一章 绪论

### 1.1 编写目的

本概要设计文档的主要目的是：

1. **指导系统开发**：为开发团队提供系统的整体架构和设计原则，确保开发过程中遵循统一的架构规范
2. **明确技术选型**：阐述系统采用的技术栈及其合理性，为技术决策提供依据
3. **规范接口设计**：定义系统对外提供的API接口规范，便于前后端协作及第三方集成
4. **支持系统测试**：为测试团队提供系统功能清单和非功能需求，指导测试用例设计
5. **指导系统部署**：描述系统的部署架构和运维要求，为生产环境部署提供参考

### 1.2 项目背景

随着量子计算技术的快速发展，传统基于大数分解和离散对数问题的公钥密码体系面临严峻挑战。为应对量子计算带来的安全威胁，国内外密码学界正在积极推进后量子密码学（Post-Quantum Cryptography，PQC）的研究和标准化工作。

在此背景下，构建一个支持传统密码学算法和后量子密码学算法的混合证书管理系统具有重要意义。该系统不仅能够满足当前企业的证书管理需求，还能为未来向全后量子密码体系过渡提供平滑过渡方案。

### 1.3 系统目标

本系统的建设目标如下：

1. **安全性目标**：支持国密SM2算法和后量子ML-DSA算法，提升证书系统的安全等级，抵御量子计算攻击
2. **可扩展性目标**：采用DDD分层架构，实现业务逻辑与技术实现的解耦，支持功能的灵活扩展
3. **高可用性目标**：通过数据库持久化和Redis缓存，保证系统7×24小时稳定运行
4. **可维护性目标**：建立完整的审计日志和证书链管理机制，便于运维监控和故障排查
5. **标准化目标**：遵循国际标准（X.509、PKCS#10、CRL）和国家标准（GB/T 35275），确保证书格式的兼容性

### 1.4 术语定义

| 术语 | 全称 | 说明 |
|------|------|------|
| DDD | Domain-Driven Design | 领域驱动设计，一种软件开发方法论 |
| CA | Certificate Authority | 证书颁发机构 |
| CSR | Certificate Signing Request | 证书签名请求 |
| CRL | Certificate Revocation List | 证书吊销列表 |
| PKCS#10 | Public-Key Cryptography Standards | 公钥加密标准，定义CSR格式 |
| PEM | Privacy-Enhanced Mail | 隐私增强邮件格式，常用于存储证书和密钥 |
| X.509 | ITU-T X.509 | 数字证书的国际标准 |
| PQC | Post-Quantum Cryptography | 后量子密码学 |
| SM2 | ShangMi 2 | 国家密码管理局颁布的公钥密码算法 |
| ML-DSA | Module-Lattice-Based Digital Signature | 基于模格的数字签名算法 |

---

## 第二章 系统概述

### 2.1 系统简介

混合证书管理系统是一个基于领域驱动设计（DDD）架构和后量子密码学技术的企业级证书管理平台。系统采用Spring Boot 3.x框架，结合Bouncy Castle密码学库，实现了证书的全生命周期管理，包括证书申请、签发、查询、吊销、续期等功能。

系统支持传统密码学算法（SM2、RSA、ECDSA）与后量子密码学算法（ML-DSA、ML-KEM）的混合签名，能够根据不同的应用场景灵活配置证书策略，满足多样化的安全需求。

### 2.2 主要功能

系统的主要功能包括：

#### 2.2.1 证书管理功能

- **证书申请**：支持普通证书和混合证书的在线申请
- **证书签发**：基于证书策略自动签发证书
- **证书查询**：提供证书详情查询和证书链查询
- **证书吊销**：支持按吊销原因吊销证书
- **证书续期**：提供证书续期服务
- **状态查询**：提供证书吊销状态的快速查询

#### 2.2.2 身份验证功能

- **身份验证**：集成第三方身份提供者（IdP），验证申请者身份
- **CSR验证**：验证证书签名请求的有效性和完整性
- **密钥算法验证**：验证密钥算法符合证书策略要求

#### 2.2.3 策略管理功能

- **策略创建**：创建自定义证书签发策略
- **策略查询**：查询策略列表和详情
- **策略激活**：激活或停用策略
- **策略验证**：根据策略验证CSR

#### 2.2.4 CA管理功能

- **CA创建**：创建根证书颁发机构和中证书颁发机构
- **CA查询**：查询CA列表和详情
- **CA激活**：激活或停用CA
- **CA吊销**：吊销CA证书

#### 2.2.5 审计功能

- **日志查询**：查询审计日志记录
- **资源审计**：查询特定资源的审计日志
- **审计统计**：获取审计统计信息

### 2.3 用户角色

系统定义了以下用户角色：

| 角色 | 职责描述 |
|------|---------|
| 系统管理员 | 负责系统配置、CA管理、策略管理、用户管理等 |
| 证书管理员 | 负责证书的签发、吊销、续期等日常管理 |
| 审计员 | 负责查询审计日志，进行安全审计 |
| 普通用户 | 提交证书申请、查询证书信息 |

---

## 第三章 系统架构设计

### 3.1 总体架构

系统采用**六层架构设计**，严格遵循DDD（领域驱动设计）分层原则，实现业务逻辑与技术实现的彻底解耦。

#### 3.1.1 架构图

```
┌─────────────────────────────────────────────────────────┐
│                    API层 (hybird-api)                    │
│              (DTO定义、统一响应格式、接口契约)              │
└─────────────────────────────────────────────────────────┘
                            ↑
┌─────────────────────────────────────────────────────────┐
│                 触发层 (hybird-trigger)                  │
│          (HTTP控制器、定时任务、领域事件监听器)            │
└─────────────────────────────────────────────────────────┘
                            ↑
┌─────────────────────────────────────────────────────────┐
│                领域层 (hybird-domain)                    │
│    (聚合根、领域服务、仓储接口、领域事件、值对象)          │
└─────────────────────────────────────────────────────────┘
                            ↑
┌─────────────────────────────────────────────────────────┐
│              基础设施层 (hybird-infrastructure)            │
│          (仓储实现、Mapper、PO、端口适配器)               │
└─────────────────────────────────────────────────────────┘
                            ↑
┌─────────────────────────────────────────────────────────┐
│                类型层 (hybird-types)                     │
│              (枚举、异常、领域事件基类)                   │
└─────────────────────────────────────────────────────────┘
                            ↑
┌─────────────────────────────────────────────────────────┐
│               应用层 (hybird-app)                         │
│          (启动类、配置类、数据初始化、依赖注入)             │
└─────────────────────────────────────────────────────────┘
```

#### 3.1.2 模块划分

系统划分为以下六个核心模块：

| 模块 | 职责 | 依赖关系 |
|------|------|---------|
| hybird-api | 定义API接口数据传输对象（DTO）和统一响应格式 | hybird-types |
| hybird-trigger | 处理HTTP请求、执行定时任务、监听领域事件 | hybird-api, hybird-types, hybird-domain, hybird-infrastructure |
| hybird-domain | 封装核心业务逻辑，定义领域模型和仓储接口 | hybird-types |
| hybird-infrastructure | 实现仓储接口，提供数据持久化和技术支撑 | hybird-domain |
| hybird-types | 定义共享类型（枚举、异常、事件） | 无依赖 |
| hybird-app | 应用启动、配置管理、数据初始化 | hybird-trigger, hybird-infrastructure |

#### 3.1.3 依赖关系图

```
hybird-app
    │
    ├─> hybird-trigger
    │       │
    │       ├─> hybird-api ──> hybird-types
    │       │
    │       ├─> hybird-domain ──> hybird-types
    │       │
    │       └─> hybird-infrastructure ──> hybird-domain ──> hybird-types
    │
    └─> hybird-infrastructure ──> hybird-domain ──> hybird-types
```

### 3.2 分层设计原则

系统严格遵循以下分层设计原则：

#### 3.2.1 依赖倒置原则

- 领域层不依赖任何外部框架，保持纯粹的业务逻辑
- 领域层定义仓储接口（Port），基础设施层实现仓储接口（Adapter）
- 高层模块不依赖低层模块，都依赖于抽象接口

#### 3.2.2 单向依赖原则

- 依赖关系只能单向，不能形成循环依赖
- 上层模块可以调用下层模块，下层模块不能调用上层模块

#### 3.2.3 开闭原则

- 对扩展开放，对修改关闭
- 新增功能时，应通过扩展而非修改现有代码实现

### 3.3 核心技术选型

#### 3.3.1 技术栈

| 分类 | 技术选型 | 版本 | 选型理由 |
|------|---------|------|---------|
| 开发语言 | Java | 17 | 生态成熟，性能优异 |
| 应用框架 | Spring Boot | 3.4.3 | 快速开发，生态丰富 |
| 密码学库 | Bouncy Castle | 1.78.1 | 支持SM2和后量子算法 |
| 持久化框架 | MyBatis | 3.x | SQL灵活，易于优化 |
| 数据库 | MySQL | 8.0 | 开源稳定，成熟可靠 |
| 缓存 | Redis | 7.x | 高性能，支持多种数据结构 |
| 构建工具 | Maven | 3.x | 标准构建工具，依赖管理 |
| 工具库 | Lombok, Guava, FastJSON | - | 简化代码，提升效率 |

#### 3.3.2 关键技术说明

##### 3.3.2.1 领域驱动设计（DDD）

DDD是一种软件开发方法论，强调以领域为中心进行软件设计。系统采用DDD的核心概念：

- **聚合根（Aggregate Root）**：数据修改的唯一入口，保证数据一致性
- **实体（Entity）**：具有唯一标识的对象
- **值对象（Value Object）**：不可变的、通过属性值判断相等的对象
- **领域服务（Domain Service）**：不属于任何聚合根的业务逻辑
- **仓储（Repository）**：管理聚合根的持久化
- **领域事件（Domain Event）**：领域内发生的重要业务事件

##### 3.3.2.2 混合签名

混合签名是指同时使用传统签名算法和后量子签名算法对同一数据进行签名。系统支持的签名算法包括：

- **传统算法**：SM2（国密）、RSA2048、RSA4096、ECDSA_P256
- **后量子算法**：ML-DSA（基于模格的数字签名算法）

混合签名的优势：
- 提供双重安全保障，抵御传统计算和量子计算攻击
- 平滑过渡，无需一次性替换整个证书体系

##### 3.3.2.3 MyBatis

MyBatis是一种优秀的持久层框架，它支持定制化SQL、存储过程以及高级映射。系统的MyBatis使用特点：

- 采用XML映射文件定义SQL语句
- 支持动态SQL和复杂查询
- 自动完成PO（持久化对象）与数据库表的映射

##### 3.3.2.4 Redis缓存

Redis是一个开源的内存数据结构存储系统，可用作数据库、缓存和消息中间件。系统的Redis使用场景：

- 缓存证书吊销状态，提升查询性能
- 缓存证书策略，减少数据库访问
- 支持缓存降级，故障时自动切换为数据库查询

---

## 第四章 领域模型设计

### 4.1 领域划分

系统划分为**6个核心业务域**，每个域包含聚合根、实体、值对象和领域服务。

#### 4.1.1 领域域划分表

| 领域 | 聚合根 | 领域服务 | 职责 |
|------|--------|---------|------|
| 身份验证域 | AuthenticationRequest | AuthenticationService | 处理身份验证请求，验证申请者身份和CSR |
| 证书生命周期域 | Certificate | CertificateLifecycleService | 管理证书签发、激活、吊销、续期、过期 |
| 签名域 | CertificateAuthority | SigningService | 执行数字签名，签发证书和CRL |
| 策略域 | CertificatePolicy | PolicyService | 定义和执行证书签发策略 |
| 证书状态查询域 | RevocationStatusCache | RevocationStatusService | 提供高性能的证书吊销状态查询 |
| 审计日志域 | AuditEvent | AuditService | 记录系统关键操作，支持完整性和追溯 |

### 4.2 核心聚合根设计

#### 4.2.1 AuthenticationRequest（身份验证请求）

**职责**：管理身份验证请求的完整生命周期

**状态流转**：PENDING_VALIDATION → VALIDATION_SUCCESSFUL / VALIDATION_FAILED

**核心属性**：

| 属性名 | 类型 | 说明 |
|--------|------|------|
| requestId | String | 请求ID，唯一标识 |
| applicant | Applicant | 申请者信息 |
| csr | CertificateSigningRequest | 证书签名请求 |
| idToken | String | 身份提供者令牌 |
| status | AuthRequestStatus | 请求状态 |
| failureReason | String | 失败原因 |
| createdAt | LocalDateTime | 创建时间 |
| validatedAt | LocalDateTime | 验证时间 |

**核心方法**：
- `startValidation()`：启动验证流程
- `completeValidation()`：验证成功
- `failValidation()`：验证失败

**领域事件**：AuthenticationCompletedEvent

#### 4.2.2 Certificate（证书）

**职责**：管理证书签发后的动态状态

**状态流转**：PENDING_ISSUANCE → ACTIVE → REVOKED / EXPIRED / RENEWAL_DUE

**核心属性**：

| 属性名 | 类型 | 说明 |
|--------|------|------|
| serialNumber | String | 证书序列号，主键 |
| certificateType | CertificateType | 证书类型 |
| certificate | Certificate | 证书数据（值对象） |
| status | CertificateStatus | 证书状态 |
| revocationInfo | RevocationInfo | 吊销信息 |
| notificationPolicy | NotificationPolicy | 通知策略 |
| renewalNoticeDays | int | 临期通知天数 |

**核心方法**：
- `activate()`：激活证书
- `revoke()`：吊销证书
- `expire()`：过期证书
- `markForRenewal()`：标记为待续期

**领域事件**：CertificateIssuedEvent、CertificateRevokedEvent、RenewalNoticeDueEvent

#### 4.2.3 CertificateAuthority（证书颁发机构）

**职责**：执行数字签名操作，签发证书和CRL

**核心属性**：

| 属性名 | 类型 | 说明 |
|--------|------|------|
| caId | String | CA ID |
| caName | String | CA名称，唯一 |
| caDN | String | CA DN |
| certificate | Certificate | CA证书 |
| privateKeyAlias | String | 私钥别名 |
| keyType | String | 密钥类型 |
| keySize | int | 密钥长度 |
| enabled | boolean | 是否启用 |

**核心方法**：
- `issueCertificate()`：签发证书
- `generateCRL()`：生成CRL
- `performSignature()`：执行混合签名

**领域事件**：CRLIssuedEvent

#### 4.2.4 CertificatePolicy（证书策略）

**职责**：定义和执行证书签发策略

**核心属性**：

| 属性名 | 类型 | 说明 |
|--------|------|------|
| policyId | String | 策略ID |
| certificateType | CertificateType | 证书类型 |
| policyName | String | 策略名称 |
| cryptographicRule | CryptographicRule | 密码学规则 |
| validityPeriodRule | ValidityPeriodRule | 有效期规则 |
| subjectDNRule | SubjectDNRule | 主题DN规则 |
| enabled | boolean | 是否启用 |

**核心方法**：
- `enable()` / `disable()`：启用/禁用策略
- `validateCryptographicParameters()`：验证密码学参数
- `validateSubjectDN()`：验证主题DN
- `validateValidityPeriod()`：验证有效期

#### 4.2.5 RevocationStatusCache（吊销状态缓存）

**职责**：提供高性能的证书吊销状态查询

**核心属性**：
- `cache`：吊销状态缓存Map
- `crlMetadata`：CRL元数据
- `lastUpdateTime`：最后更新时间

**核心方法**：
- `isRevoked()`：检查证书是否吊销
- `batchCheckRevocation()`：批量检查
- `updateFromCRL()`：从CRL更新缓存

#### 4.2.6 AuditEvent（审计事件）

**职责**：记录系统关键操作日志，支持完整性验证

**核心属性**：

| 属性名 | 类型 | 说明 |
|--------|------|------|
| logId | Long | 日志ID，自增主键 |
| eventType | String | 事件类型 |
| payload | String | 事件数据（JSON） |
| payloadHash | String | 负载哈希（SHA-256） |
| operator | String | 操作人 |
| ipAddress | String | 客户端IP |
| timestamp | TimestampValueObject | 时间戳 |

**核心方法**：
- `computePayloadHash()`：计算负载哈希值
- `verifyPayloadIntegrity()`：验证负载完整性
- `setPayloadWithHash()`：设置负载并计算哈希

### 4.3 领域事件机制

系统采用**领域事件驱动**模式实现业务解耦，当领域内发生重要业务事件时，聚合根会发布领域事件，监听器异步处理事件。

#### 4.3.1 领域事件列表

| 事件 | 触发时机 | 消费者 |
|------|---------|--------|
| AuthenticationCompletedEvent | 身份验证成功/失败 | 审计日志、证书签发 |
| CertificateIssuedEvent | 证书签发成功 | 审计日志、证书链管理 |
| CertificateRevokedEvent | 证书吊销 | 审计日志、CRL更新 |
| CRLIssuedEvent | CRL生成 | 审计日志、缓存更新 |
| RenewalNoticeDueEvent | 证书临期 | 通知服务、审计日志 |

#### 4.3.2 事件处理流程

```
聚合根发布领域事件
    ↓
Spring事件总线广播事件
    ↓
异步监听器接收事件
    ↓
监听器处理事件（记录审计日志、更新缓存等）
```

---

## 第五章 接口设计

### 5.1 接口概述

系统提供RESTful API接口，采用JSON格式进行数据交换，所有接口遵循统一的响应格式。

### 5.2 统一响应格式

所有接口的响应遵循以下统一格式：

```json
{
  "code": "0000",
  "info": "success",
  "data": {}
}
```

**字段说明**：

| 字段名 | 类型 | 说明 |
|--------|------|------|
| code | String | 响应码，"0000"表示成功，"9999"表示失败 |
| info | String | 响应消息 |
| data | Object | 响应数据，具体结构根据接口而定 |

### 5.3 证书管理接口

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 证书申请 | POST | /api/certificate/apply | 申请普通证书 |
| 混合证书申请 | POST | /api/certificate/apply/hybrid | 申请混合证书 |
| 证书查询 | GET | /api/certificate/query | 查询证书详情 |
| 证书链查询 | GET | /api/certificate/chain | 查询证书链 |
| 设备证书查询 | GET | /api/certificate/device | 查询设备证书列表 |
| 证书吊销 | POST | /api/certificate/revoke | 吊销证书 |
| 证书续期 | POST | /api/certificate/renew | 续期证书 |
| 状态查询 | POST | /api/certificate/status | 查询证书吊销状态 |
| CRL生成 | POST | /api/certificate/crl/generate | 生成CRL |

### 5.4 身份验证接口

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 身份验证 | POST | /api/authentication/validate | 处理身份验证请求 |

### 5.5 策略管理接口

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 创建策略 | POST | /api/policy/create | 创建证书策略 |
| 策略列表 | GET | /api/policy/list | 查询所有策略 |
| 策略详情 | GET | /api/policy/{policyId} | 查询策略详情 |
| 激活策略 | POST | /api/policy/{policyId}/activate | 激活/停用策略 |
| 验证CSR | POST | /api/policy/validate | 根据策略验证CSR |

### 5.6 CA管理接口

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 创建CA | POST | /api/ca/create | 创建证书颁发机构 |
| CA列表 | GET | /api/ca/list | 查询所有CA |
| CA详情 | GET | /api/ca/{caId} | 查询CA详情 |
| 激活CA | POST | /api/ca/{caId}/activate | 激活/停用CA |
| 吊销CA | POST | /api/ca/{caId}/revoke | 吊销CA |

### 5.7 审计日志接口

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 查询日志 | POST | /api/audit/query | 查询审计日志 |
| 资源日志 | GET | /api/audit/resource/{type}/{id} | 查询资源审计日志 |
| 审计统计 | GET | /api/audit/statistics | 获取审计统计信息 |

---

## 第六章 数据库设计

### 6.1 数据库概述

系统采用MySQL 8.0数据库，共设计7张核心业务表，支持证书的全生命周期管理和审计追溯。

### 6.2 数据库配置

**数据库地址**：49.233.215.82:3306
**数据库名称**：hybird
**用户名**：admin
**密码**：wyman1112
**字符集**：UTF-8
**时区**：Asia/Shanghai

### 6.3 核心表设计

#### 6.3.1 数据库表结构

系统共定义**7张核心业务表**：

| 表名 | 说明 | 主键 |
|------|------|------|
| certificate | 证书信息表 | serial_number |
| authentication_request | 身份验证请求表 | request_id |
| certificate_policy | 证书策略表 | policy_id |
| certificate_authority | CA证书表 | ca_id |
| audit_log | 审计日志表 | log_id |
| certificate_chain | 证书链表 | chain_id |
| revocation_status_cache | 吊销状态缓存表 | cache_id |

---

## 第七章 非功能需求

### 7.1 性能要求

| 指标名称 | 目标值 | 说明 |
|---------|-------|------|
| 证书查询响应时间 | ≤ 100ms | 使用Redis缓存 |
| 证书签发响应时间 | ≤ 500ms | 包含身份验证和签名 |
| 批量吊销状态查询 | ≤ 200ms | 10个证书 |
| 并发用户数 | ≥ 1000 | 支持的在线用户数 |

### 7.2 安全要求

- **通信安全**：使用HTTPS/TLS加密传输
- **数据安全**：敏感信息加密存储（私钥、证书PEM）
- **访问控制**：基于角色的访问控制（RBAC）
- **审计追踪**：完整记录所有关键操作
- **密钥管理**：支持硬件安全模块（HSM）集成

### 7.3 可靠性要求

- **系统可用性**：≥ 99.9%
- **数据持久化**：数据库主从复制
- **缓存高可用**：Redis哨兵模式
- **服务降级**：Redis故障时自动降级为数据库查询

### 7.4 可维护性要求

- **日志记录**：分级日志（ERROR、WARN、INFO、DEBUG）
- **监控告警**：关键指标监控（证书数量、过期证书、错误率）
- **版本管理**：数据库版本控制（Flyway）
- **文档规范**：API文档、架构文档、部署文档齐全

---

## 第八章 定时任务设计

### 8.1 定时任务概述

系统设计了3个定时任务，用于自动化的证书生命周期管理和系统维护。

### 8.2 定时任务列表

| 任务编号 | 任务名称 | 执行时间 | 任务描述 |
|---------|---------|---------|---------|
| T-01 | 证书过期检查 | 每日01:00 | 检查并标记过期证书 |
| T-02 | 证书临期通知 | 每日08:00 | 扫描临期证书并发送通知 |
| T-03 | CRL更新 | 每日02:00 | 更新CRL和吊销状态缓存 |

### 8.3 证书过期检查任务

**任务名称**：CertificateExpiryCheckJob.checkExpiredCertificates()

**执行时间**：每日01:00

**任务描述**：
1. 查询所有状态为ACTIVE的证书
2. 检查证书的notAfter时间是否小于当前时间
3. 将过期证书的状态更新为EXPIRED
4. 记录过期证书的审计日志

### 8.4 证书临期通知任务

**任务名称**：CertificateExpiryCheckJob.scanExpiringCertificates()

**执行时间**：每日08:00

**任务描述**：
1. 查询所有状态为ACTIVE的证书
2. 检查证书的notAfter时间是否在临期通知天数内（默认30天）
3. 发布RenewalNoticeDueEvent事件
4. 记录临期通知的审计日志

### 8.5 CRL更新任务

**任务名称**：CRLUpdateJob.updateCRL()

**执行时间**：每日02:00

**任务描述**：
1. 查询所有启用的CA
2. 为每个CA查询所有已吊销的证书
3. 生成CRL（证书吊销列表）
4. 发布CRLIssuedEvent事件
5. 更新吊销状态缓存
6. 记录CRL生成的审计日志

---

## 第九章 缓存策略设计

### 9.1 缓存概述

系统采用Redis作为缓存服务，提升查询性能，降低数据库负载。

### 9.2 缓存配置

**Redis配置**：
- 主机：49.233.215.82
- 端口：6379
- 密码：wyman1112
- 数据库：0
- 最大连接数：10

### 9.3 缓存对象

| 缓存对象 | 缓存键 | 过期时间 | 说明 |
|---------|-------|---------|------|
| 证书吊销状态 | revocation:cache | 24小时 | 存储所有证书的吊销状态 |
| 证书策略 | policy:{policyId} | 1小时 | 存储证书策略详情 |

### 9.4 缓存更新策略

| 缓存对象 | 更新时机 | 更新方式 |
|---------|---------|---------|
| 证书吊销状态 | CRL更新时 | 全量更新 |
| 证书策略 | 策略变更时 | 单条更新 |

### 9.5 缓存降级

当Redis不可用时，系统自动降级为数据库查询：
- 监控Redis连接状态
- 连接失败时记录告警
- 所有缓存查询改为数据库查询
- Redis恢复后自动切换回缓存查询

---

## 第十章 部署架构设计

### 10.1 部署模式

系统支持单机部署和分布式部署两种模式。

### 10.2 单机部署架构

**适用场景**：开发环境、测试环境、小规模生产环境

**Draw.io代码**（可直接导入draw.io编辑器）：

```xml
<mxfile host="app.diagrams.net" modified="2025-01-04T00:00:00.000Z" agent="draw.io" etag="v1">
  <diagram name="单机部署架构" id="single-deployment">
    <mxGraphModel dx="1422" dy="794" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="850" pageHeight="1100" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />

        <!-- 互联网/客户端 -->
        <mxCell id="internet" value="Internet / 用户终端" style="shape=cloud;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=14;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="320" y="20" width="210" height="60" as="geometry" />
        </mxCell>

        <!-- 防火墙 -->
        <mxCell id="firewall" value="防火墙&#xa;(Firewall)&#xa;端口: 80/443/22" style="shape=process;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="335" y="100" width="180" height="70" as="geometry" />
        </mxCell>

        <!-- Nginx反向代理 -->
        <mxCell id="nginx" value="Nginx&#xa;反向代理&#xa;端口: 80/443" style="shape=mxgraph.aws3.load_balancer_classic;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="350" y="200" width="150" height="80" as="geometry" />
        </mxCell>

        <!-- 应用服务器容器 -->
        <mxCell id="app-server-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="250" y="300" width="350" height="320" as="geometry" />
        </mxCell>
        <mxCell id="app-server-label" value="应用服务器 (App Server)&#xa;IP: 192.168.1.10 | CPU: 4核 | 内存: 8GB" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=12;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="250" y="300" width="350" height="30" as="geometry" />
        </mxCell>

        <!-- Spring Boot应用 -->
        <mxCell id="springboot" value="Spring Boot&#xa;混合证书管理系统&#xa;端口: 8080&#xa;JDK: 17" style="shape=mxgraph.devices.server;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="320" y="340" width="210" height="120" as="geometry" />
        </mxCell>

        <!-- MySQL数据库 -->
        <mxCell id="mysql" value="MySQL 数据库&#xa;端口: 3306&#xa;版本: 8.0&#xa;库: hybird" style="shape=cylinder3;whiteSpace=wrap;html=1;boundedLbl=1;backgroundOutline=1;size=15;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="290" y="480" width="130" height="100" as="geometry" />
        </mxCell>

        <!-- Redis缓存 -->
        <mxCell id="redis" value="Redis 缓存&#xa;端口: 6379&#xa;版本: 7.x&#xa;DB: 0" style="shape=cylinder3;whiteSpace=wrap;html=1;boundedLbl=1;backgroundOutline=1;size=15;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="440" y="480" width="130" height="100" as="geometry" />
        </mxCell>

        <!-- 日志存储 -->
        <mxCell id="logs" value="日志存储&#xa;/export/Logs&#xa;• access.log&#xa;• error.log&#xa;• gc.log" style="shape=folder;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="290" y="585" width="130" height="70" as="geometry" />
        </mxCell>

        <!-- 证书存储 -->
        <mxCell id="cert-storage" value="证书存储&#xa;/export/Certs&#xa;• CA根证书&#xa;• 证书文件&#xa;• CRL文件" style="shape=folder;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="440" y="585" width="130" height="70" as="geometry" />
        </mxCell>

        <!-- 监控告警 -->
        <mxCell id="monitor" value="监控告警&#xa;(可选)&#xa;• Prometheus&#xa;• Grafana&#xa;• AlertManager" style="shape=mxgraph.aws2.general_server;html=1;fillColor=#f5f5f5;strokeColor=#666666;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="250" y="640" width="100" height="60" as="geometry" />
        </mxCell>

        <!-- 连接线 -->
        <mxCell id="line1" edge="1" parent="1" source="internet" target="firewall">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="line2" edge="1" parent="1" source="firewall" target="nginx">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="line3" edge="1" parent="1" source="nginx" target="springboot">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="line4" edge="1" parent="1" source="springboot" target="mysql">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="line5" edge="1" parent="1" source="springboot" target="redis">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="line6" edge="1" parent="1" source="springboot" target="logs">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="line7" edge="1" parent="1" source="springboot" target="cert-storage">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- 图例说明 -->
        <mxCell id="legend" value="图例说明：&#xa;━━━━━━━━━━━━━━━&#xa;🌐 互联网接入&#xa;🛡️ 安全边界&#xa;⚖️ 负载均衡/反向代理&#xa;🖥️ 应用服务&#xa;🗄️ 数据存储&#xa;📁 文件存储" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#000000;align=left;verticalAlign=top;spacingLeft=10;fontSize=11;fontFamily=Courier New;" vertex="1" parent="1">
          <mxGeometry x="620" y="20" width="180" height="180" as="geometry" />
        </mxCell>

        <!-- 部署说明 -->
        <mxCell id="deploy-info" value="部署说明：&#xa;━━━━━━━━━━━━━━━&#xa;1. 应用服务监听端口8080&#xa;2. Nginx反向代理80/443端口&#xa;3. MySQL存储业务数据&#xa;4. Redis缓存吊销状态&#xa;5. 日志目录配置为/export/Logs&#xa;6. 证书文件存储在/export/Certs" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff4e6;strokeColor=#ff8000;align=left;verticalAlign=top;spacingLeft=10;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="620" y="220" width="180" height="180" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
```

**架构图（文本展示）**：

```
Internet / 用户终端
         │
         ▼
    ┌─────────┐
    │ 防火墙   │ ← 端口: 80/443/22
    │Firewall │
    └────┬────┘
         │
         ▼
  ┌──────────────┐
  │ Nginx 反向代理│ ← 端口: 80/443
  └──────┬───────┘
         │
         ▼
┌────────────────────────────────────────┐
│   应用服务器 (192.168.1.10)            │
│   CPU: 4核 | 内存: 8GB | 磁盘: 100GB  │
│                                        │
│   ┌────────────────────────────┐       │
│   │  Spring Boot (端口: 8080)  │       │
│   │  - HTTP服务                │       │
│   │  - 定时任务                │       │
│   │  - 事件监听器              │       │
│   └────┬────────┬────────┬────┘       │
│        │        │        │            │
│   ┌────▼───┐ ┌──▼────┐ ┌─▼──────┐    │
│   │ MySQL  │ │ Redis │ │日志存储│    │
│   │ :3306  │ │ :6379 │ │        │    │
│   └────────┘ └───────┘ └────────┘    │
│                                        │
│   ┌──────────────┐                    │
│   │ 证书存储     │                    │
│   │ /export/Certs│                    │
│   └──────────────┘                    │
└────────────────────────────────────────┘
```

**服务器配置建议**：

| 资源类型 | 配置 | 说明 |
|---------|------|------|
| CPU | 4核 | 推荐Intel Xeon或AMD EPYC |
| 内存 | 8GB | DDR4及以上 |
| 磁盘 | 100GB SSD | 系统盘+数据盘 |
| 操作系统 | CentOS 7.9+ / Ubuntu 20.04+ | Linux系统 |
| JDK版本 | OpenJDK 17 | Java运行环境 |
| MySQL版本 | 8.0+ | 数据库服务 |
| Redis版本 | 7.x | 缓存服务 |
| Nginx版本 | 1.18+ | 反向代理 |

### 10.3 分布式部署架构

**适用场景**：大规模生产环境、高可用、高性能

**Draw.io代码**（可直接导入draw.io编辑器）：

```xml
<mxfile host="app.diagrams.net" modified="2025-01-04T00:00:00.000Z" agent="draw.io" etag="v1">
  <diagram name="分布式部署架构" id="distributed-deployment">
    <mxGraphModel dx="1422" dy="794" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1200" pageHeight="1600" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />

        <!-- 互联网/客户端 -->
        <mxCell id="internet" value="Internet / 用户终端&#xa;CDN加速 (可选)" style="shape=cloud;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=14;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="480" y="10" width="240" height="70" as="geometry" />
        </mxCell>

        <!-- WAF防火墙 -->
        <mxCell id="waf" value="WAF防火墙&#xa;(Web Application Firewall)&#xa;• SQL注入防护&#xa;• XSS攻击防护" style="shape=process;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="490" y="100" width="220" height="80" as="geometry" />
        </mxCell>

        <!-- 第一层负载均衡（F5/Nginx） -->
        <mxCell id="lb1" value="负载均衡器 (Layer 1)&#xa;F5 / 硬件LB&#xa;VIP: 公网IP&#xa;协议: TCP/HTTP/HTTPS" style="shape=mxgraph.aws3.elastic_load_balancing_application;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="490" y="200" width="220" height="90" as="geometry" />
        </mxCell>

        <!-- Nginx反向代理集群 -->
        <mxCell id="nginx-cluster-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;strokeWidth=2;dashed=1;" vertex="1" parent="1">
          <mxGeometry x="150" y="310" width="900" height="120" as="geometry" />
        </mxCell>
        <mxCell id="nginx-cluster-label" value="Nginx反向代理集群&#xa;端口: 80/443" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=12;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="150" y="310" width="900" height="25" as="geometry" />
        </mxCell>

        <!-- Nginx Node 1 -->
        <mxCell id="nginx1" value="Nginx Node 1&#xa;192.168.1.101" style="shape=mxgraph.aws3.load_balancer_classic;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="180" y="340" width="120" height="70" as="geometry" />
        </mxCell>

        <!-- Nginx Node 2 -->
        <mxCell id="nginx2" value="Nginx Node 2&#xa;192.168.1.102" style="shape=mxgraph.aws3.load_balancer_classic;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="330" y="340" width="120" height="70" as="geometry" />
        </mxCell>

        <!-- Keepalived -->
        <mxCell id="keepalived" value="Keepalived&#xa;VIP: 192.168.1.100" style="shape=rounded;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="470" y="340" width="120" height="70" as="geometry" />
        </mxCell>

        <!-- Nginx Node 3 -->
        <mxCell id="nginx3" value="Nginx Node 3&#xa;192.168.1.103" style="shape=mxgraph.aws3.load_balancer_classic;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="620" y="340" width="120" height="70" as="geometry" />
        </mxCell>

        <!-- Nginx Node 4 -->
        <mxCell id="nginx4" value="Nginx Node 4&#xa;192.168.1.104" style="shape=mxgraph.aws3.load_balancer_classic;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="770" y="340" width="120" height="70" as="geometry" />
        </mxCell>

        <!-- 应用服务器集群 -->
        <mxCell id="app-cluster-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;strokeWidth=2;dashed=1;" vertex="1" parent="1">
          <mxGeometry x="150" y="450" width="900" height="350" as="geometry" />
        </mxCell>
        <mxCell id="app-cluster-label" value="Spring Boot应用服务器集群&#xa;端口: 8080 | CPU: 8核 | 内存: 16GB | JDK: 17" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=12;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="150" y="450" width="900" height="25" as="geometry" />
        </mxCell>

        <!-- App Node 1 -->
        <mxCell id="app1" value="App Node 1&#xa;192.168.2.101:8080&#xa;Spring Boot&#xa;混合证书管理系统" style="shape=mxgraph.devices.server;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="180" y="480" width="150" height="100" as="geometry" />
        </mxCell>

        <!-- App Node 2 -->
        <mxCell id="app2" value="App Node 2&#xa;192.168.2.102:8080&#xa;Spring Boot&#xa;混合证书管理系统" style="shape=mxgraph.devices.server;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="360" y="480" width="150" height="100" as="geometry" />
        </mxCell>

        <!-- App Node 3 -->
        <mxCell id="app3" value="App Node 3&#xa;192.168.2.103:8080&#xa;Spring Boot&#xa;混合证书管理系统" style="shape=mxgraph.devices.server;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="540" y="480" width="150" height="100" as="geometry" />
        </mxCell>

        <!-- App Node 4 -->
        <mxCell id="app4" value="App Node 4&#xa;192.168.2.104:8080&#xa;Spring Boot&#xa;混合证书管理系统" style="shape=mxgraph.devices.server;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="720" y="480" width="150" height="100" as="geometry" />
        </mxCell>

        <!-- App Node 5 -->
        <mxCell id="app5" value="App Node 5&#xa;192.168.2.105:8080&#xa;Spring Boot&#xa;混合证书管理系统" style="shape=mxgraph.devices.server;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="180" y="600" width="150" height="100" as="geometry" />
        </mxCell>

        <!-- App Node 6 -->
        <mxCell id="app6" value="App Node 6&#xa;192.168.2.106:8080&#xa;Spring Boot&#xa;混合证书管理系统" style="shape=mxgraph.devices.server;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="360" y="600" width="150" height="100" as="geometry" />
        </mxCell>

        <!-- 会话共享中心 -->
        <mxCell id="session" value="会话共享中心&#xa;• Redis Session&#xa;• Spring Session&#xa;• JWT Token" style="shape=rounded;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="540" y="610" width="150" height="80" as="geometry" />
        </mxCell>

        <!-- 日志收集中心 -->
        <mxCell id="log-center" value="日志收集中心&#xa;• ELK Stack&#xa;• Filebeat&#xa;• Logstash" style="shape=rounded;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="720" y="610" width="150" height="80" as="geometry" />
        </mxCell>

        <!-- MySQL主从集群 -->
        <mxCell id="mysql-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;strokeWidth=2;dashed=1;" vertex="1" parent="1">
          <mxGeometry x="50" y="820" width="450" height="200" as="geometry" />
        </mxCell>
        <mxCell id="mysql-label" value="MySQL主从集群&#xa;版本: 8.0+ | 端口: 3306" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=12;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="50" y="820" width="450" height="25" as="geometry" />
        </mxCell>

        <!-- MySQL Master -->
        <mxCell id="mysql-master" value="MySQL Master&#xa;192.168.3.101:3306&#xa;• 写操作&#xa;• 主同步" style="shape=cylinder3;whiteSpace=wrap;html=1;boundedLbl=1;backgroundOutline=1;size=15;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="80" y="855" width="130" height="130" as="geometry" />
        </mxCell>

        <!-- MySQL Slave 1 -->
        <mxCell id="mysql-slave1" value="MySQL Slave 1&#xa;192.168.3.102:3306&#xa;• 读操作&#xa;• 从同步" style="shape=cylinder3;whiteSpace=wrap;html=1;boundedLbl=1;backgroundOutline=1;size=15;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="230" y="855" width="130" height="130" as="geometry" />
        </mxCell>

        <!-- MySQL Slave 2 -->
        <mxCell id="mysql-slave2" value="MySQL Slave 2&#xa;192.168.3.103:3306&#xa;• 读操作&#xa;• 从同步" style="shape=cylinder3;whiteSpace=wrap;html=1;boundedLbl=1;backgroundOutline=1;size=15;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="380" y="855" width="130" height="130" as="geometry" />
        </mxCell>

        <!-- Redis哨兵集群 -->
        <mxCell id="redis-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;strokeWidth=2;dashed=1;" vertex="1" parent="1">
          <mxGeometry x="520" y="820" width="350" height="200" as="geometry" />
        </mxCell>
        <mxCell id="redis-label" value="Redis哨兵集群&#xa;版本: 7.x | 端口: 6379, 26379" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=12;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="520" y="820" width="350" height="25" as="geometry" />
        </mxCell>

        <!-- Redis Master -->
        <mxCell id="redis-master" value="Redis Master&#xa;192.168.4.101:6379&#xa;• 主节点" style="shape=cylinder3;whiteSpace=wrap;html=1;boundedLbl=1;backgroundOutline=1;size=15;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="550" y="855" width="130" height="130" as="geometry" />
        </mxCell>

        <!-- Redis Sentinel 1 -->
        <mxCell id="redis-sentinel1" value="Redis Sentinel 1&#xa;192.168.4.102:26379&#xa;• 哨兵节点1" style="shape=cylinder3;whiteSpace=wrap;html=1;boundedLbl=1;backgroundOutline=1;size=15;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="700" y="855" width="130" height="130" as="geometry" />
        </mxCell>

        <!-- 文件存储集群 -->
        <mxCell id="storage-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;strokeWidth=2;dashed=1;" vertex="1" parent="1">
          <mxGeometry x="900" y="820" width="250" height="200" as="geometry" />
        </mxCell>
        <mxCell id="storage-label" value="文件存储集群&#xa;NFS / MinIO / OSS" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=12;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="900" y="820" width="250" height="25" as="geometry" />
        </mxCell>

        <!-- NFS存储 -->
        <mxCell id="nfs" value="NFS共享存储&#xa;192.168.5.101&#xa;• 证书文件&#xa;• 日志归档&#xa;• CRL文件" style="shape=folder;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="930" y="855" width="120" height="130" as="geometry" />
        </mxCell>

        <!-- MinIO -->
        <mxCell id="minio" value="MinIO对象存储&#xa;192.168.5.102&#xa;• 证书备份&#xa;• 数据归档" style="shape=folder;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="1060" y="855" width="120" height="130" as="geometry" />
        </mxCell>

        <!-- 监控告警系统 -->
        <mxCell id="monitoring-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;strokeWidth=2;dashed=1;" vertex="1" parent="1">
          <mxGeometry x="50" y="1040" width="550" height="180" as="geometry" />
        </mxCell>
        <mxCell id="monitoring-label" value="监控告警系统&#xa;实时监控 / 异常告警 / 性能分析" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=12;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="50" y="1040" width="550" height="25" as="geometry" />
        </mxCell>

        <!-- Prometheus -->
        <mxCell id="prometheus" value="Prometheus&#xa;192.168.6.101:9090&#xa;• 指标采集&#xa;• 时序存储" style="shape=mxgraph.aws2.monitoring;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="80" y="1070" width="150" height="100" as="geometry" />
        </mxCell>

        <!-- Grafana -->
        <mxCell id="grafana" value="Grafana&#xa;192.168.6.102:3000&#xa;• 可视化面板&#xa;• 实时监控" style="shape=mxgraph.aws2.dashboard;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="250" y="1070" width="150" height="100" as="geometry" />
        </mxCell>

        <!-- AlertManager -->
        <mxCell id="alertmanager" value="AlertManager&#xa;192.168.6.103:9093&#xa;• 告警分发&#xa;• 通知发送" style="shape=mxgraph.aws2.sns;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="420" y="1070" width="150" height="100" as="geometry" />
        </mxCell>

        <!-- 安全系统 -->
        <mxCell id="security-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;strokeWidth=2;dashed=1;" vertex="1" parent="1">
          <mxGeometry x="620" y="1040" width="530" height="180" as="geometry" />
        </mxCell>
        <mxCell id="security-label" value="安全防护系统&#xa;身份认证 / 访问控制 / 审计追踪" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=12;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="620" y="1040" width="530" height="25" as="geometry" />
        </mxCell>

        <!-- LDAP/AD -->
        <mxCell id="ldap" value="LDAP / AD&#xa;192.168.7.101&#xa;• 用户认证&#xa;• 权限管理" style="shape=mxgraph.aws2.directory_service;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="650" y="1070" width="150" height="100" as="geometry" />
        </mxCell>

        <!-- HSM -->
        <mxCell id="hsm" value="HSM&#xa;(硬件安全模块)&#xa;192.168.7.102&#xa;• 密钥管理&#xa;• 签名服务" style="shape=mxgraph.aws2.hsm;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="820" y="1070" width="150" height="100" as="geometry" />
        </mxCell>

        <!-- SIEM -->
        <mxCell id="siem" value="SIEM&#xa;192.168.7.103&#xa;• 日志分析&#xa;• 威胁检测" style="shape=mxgraph.aws2.security_hub;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="990" y="1070" width="150" height="100" as="geometry" />
        </mxCell>

        <!-- 备份系统 -->
        <mxCell id="backup-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;strokeWidth=2;dashed=1;" vertex="1" parent="1">
          <mxGeometry x="50" y="1240" width="400" height="120" as="geometry" />
        </mxCell>
        <mxCell id="backup-label" value="备份与容灾系统&#xa;数据备份 / 灾难恢复 / 异地容灾" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=12;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="50" y="1240" width="400" height="25" as="geometry" />
        </mxCell>

        <!-- MySQL备份 -->
        <mxCell id="mysql-backup" value="MySQL备份&#xa;• 全量备份&#xa;• 增量备份&#xa;• Binlog备份" style="shape=mxgraph.aws2.backup;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="80" y="1270" width="150" height="70" as="geometry" />
        </mxCell>

        <!-- 文件备份 -->
        <mxCell id="file-backup" value="文件备份&#xa;• NFS备份&#xa;• MinIO同步&#xa;• 快照备份" style="shape=mxgraph.aws2.backup;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="250" y="1270" width="150" height="70" as="geometry" />
        </mxCell>

        <!-- 部署说明 -->
        <mxCell id="deploy-info" value="部署说明：&#xa;━━━━━━━━━━━━━━━&#xa;1. 负载均衡器使用F5硬件或Nginx+Keepalived&#xa;2. Nginx集群提供反向代理和静态资源服务&#xa;3. 应用服务器集群支持水平扩展&#xa;4. MySQL主从复制实现读写分离&#xa;5. Redis哨兵模式保证高可用&#xa;6. NFS共享存储证书文件和日志&#xa;7. Prometheus+Grafana实现全链路监控&#xa;8. HSM硬件模块保证密钥安全&#xa;9. 备份系统确保数据安全" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff4e6;strokeColor=#ff8000;align=left;verticalAlign=top;spacingLeft=10;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="470" y="1240" width="300" height="200" as="geometry" />
        </mxCell>

        <!-- 服务器配置说明 -->
        <mxCell id="config-info" value="服务器配置：&#xa;━━━━━━━━━━━━━━━&#xa;【应用服务器】&#xa;CPU: 8核 | 内存: 16GB | 磁盘: 200GB SSD&#xa;数量: 6台（可扩展）&#xa;&#xa;【数据库服务器】&#xa;Master: CPU 16核 | 内存: 32GB | 磁盘: 500GB SSD&#xa;Slave: CPU 16核 | 内存: 32GB | 磁盘: 500GB SSD&#xa;数量: 1主2从&#xa;&#xa;【Redis服务器】&#xa;CPU: 4核 | 内存: 16GB | 磁盘: 100GB SSD&#xa;数量: 1主2哨兵&#xa;&#xa;【存储服务器】&#xa;CPU: 4核 | 内存: 8GB | 磁盘: 2TB HDD&#xa;数量: 2台（NFS+MinIO）" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e8f4f8;strokeColor=#0091bd;align=left;verticalAlign=top;spacingLeft=10;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="790" y="1240" width="360" height="220" as="geometry" />
        </mxCell>

        <!-- 连接线 -->
        <mxCell id="line1" edge="1" parent="1" source="internet" target="waf">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="line2" edge="1" parent="1" source="waf" target="lb1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="line3" edge="1" parent="1" source="lb1" target="nginx1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="line4" edge="1" parent="1" source="nginx1" target="app1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="line5" edge="1" parent="1" source="app1" target="mysql-master">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="line6" edge="1" parent="1" source="mysql-master" target="mysql-slave1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="line7" edge="1" parent="1" source="app1" target="redis-master">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- 图例说明 -->
        <mxCell id="legend" value="图例说明：&#xa;━━━━━━━━━━━━━━━&#xa;🌐 互联网接入/CDN&#xa;🛡️ 安全防护(WAF/Firewall)&#xa;⚖️ 负载均衡(Load Balancer)&#xa;🌐 反向代理(Nginx)&#xa;🖥️ 应用服务器(App Server)&#xa;🗄️ 数据存储(MySQL/Redis)&#xa;📁 文件存储(NFS/MinIO)&#xa;📊 监控告警(Prometheus/Grafana)&#xa;🔐 安全系统(LDAP/HSM/SIEM)&#xa;💾 备份系统(Backup)&#xa;🔄 集群/高可用" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#000000;align=left;verticalAlign=top;spacingLeft=10;fontSize=9;fontFamily=Courier New;" vertex="1" parent="1">
          <mxGeometry x="1120" y="10" width="180" height="250" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
```

**架构图（文本展示）**：

```
Internet / 用户终端 (CDN加速)
         │
         ▼
┌─────────────────────┐
│   WAF防火墙          │ ← SQL注入/XSS/DDoS防护
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│  负载均衡器 (F5)    │ ← 硬件LB，VIP: 公网IP
└─────────┬───────────┘
          │
          ▼
┌─────────────────────────────────────────────────┐
│  Nginx反向代理集群 (VIP: 192.168.1.100)        │
│  ┌──────────┬──────────┬──────────┬──────────┐  │
│  │ Nginx-1  │ Nginx-2  │ Nginx-3  │ Nginx-4  │  │
│  │ .101     │ .102     │ .103     │ .104     │  │
│  └────┬─────┴────┬─────┴────┬─────┴────┬─────┘  │
│       └──────────┴──────────┴──────────┘       │
│              Keepalived (高可用)                  │
└──────────────────┬──────────────────────────────┘
                   │
        ┌──────────┼──────────┬──────────┬──────────┐
        ▼          ▼          ▼          ▼          ▼
  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐
  │App-Node1│ │App-Node2│ │App-Node3│ │App-Node4│ │App-Node5│
  │.101:8080│ │.102:8080│ │.103:8080│ │.104:8080│ │.105:8080│
  │CPU: 8核  │ │CPU: 8核  │ │CPU: 8核  │ │CPU: 8核  │ │CPU: 8核  │
  │Mem: 16GB │ │Mem: 16GB │ │Mem: 16GB │ │Mem: 16GB │ │Mem: 16GB │
  │SpringBoot│ │SpringBoot│ │SpringBoot│ │SpringBoot│ │SpringBoot│
  └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘
       │           │           │           │           │
       └───────────┴───────────┴───────────┴───────────┘
                           │
        ┌──────────────────┼──────────────────┐
        ▼                  ▼                  ▼
  ┌─────────────┐   ┌─────────────┐   ┌─────────────┐
  │MySQL主从集群│   │Redis哨兵集群 │   │文件存储集群 │
  │Master: 101  │   │Master: 101  │   │NFS: 101     │
  │Slave: 102   │   │Sentinel:102 │   │MinIO: 102   │
  │Slave: 103   │   │Sentinel:103 │   │             │
  │写: Master   │   │主从复制     │   │证书/日志    │
  │读: Slave    │   │高可用       │   │备份归档     │
  └─────────────┘   └─────────────┘   └─────────────┘
                           │
        ┌──────────────────┼──────────────────┐
        ▼                  ▼                  ▼
  ┌─────────────┐   ┌─────────────┐   ┌─────────────┐
  │监控告警系统 │   │安全防护系统 │   │备份容灾系统 │
  │Prometheus   │   │LDAP/AD     │   │MySQL备份    │
  │Grafana      │   │HSM         │   │文件备份     │
  │AlertManager │   │SIEM        │   │快照备份     │
  └─────────────┘   └─────────────┘   └─────────────┘
```

**网络拓扑图**：

```
                    ┌──────────────┐
                    │   Internet   │
                    └──────┬───────┘
                           │ 80/443
                           ▼
┌───────────────────────────────────────────────────────────┐
│                        DMZ区域                               │
├───────────────────────────────────────────────────────────┤
│  ┌──────────┐    ┌──────────┐    ┌──────────┐              │
│  │   WAF    │───▶│   F5 LB  │───▶│  Nginx   │              │
│  │ Firewall │    │  VIP     │    │  Cluster │              │
│  └──────────┘    └──────────┘    └──────────┘              │
└────────────────────┬────────────────────────────────────────┘
                     │ 192.168.1.x
                     ▼
┌───────────────────────────────────────────────────────────┐
│                        应用区域                              │
├───────────────────────────────────────────────────────────┤
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐      │
│  │ App-Node1│ │ App-Node2│ │ App-Node3│ │ App-Node4│      │
│  │ 192.168. │ │ 192.168. │ │ 192.168. │ │ 192.168. │      │
│  │   2.101   │ │   2.102   │ │   2.103   │ │   2.104   │      │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘      │
└────────────────────┬────────────────────────────────────────┘
                     │
        ┌────────────┼────────────┐
        ▼            ▼            ▼
┌───────────┐ ┌───────────┐ ┌───────────┐
│ 数据库区域 │ │ 缓存区域   │ │ 存储区域   │
├───────────┤ ├───────────┤ ├───────────┤
│ MySQL:    │ │ Redis:    │ │ NFS:      │
│ 192.168.3.│ │ 192.168.4.│ │ 192.168.5.│
│ Master+   │ │ Master+   │ │           │
│ Slaves    │ │ Sentinels │ │ MinIO:    │
└───────────┘ └───────────┘ │ 192.168.5.│
                            └───────────┘
                     │
        ┌────────────┼────────────┐
        ▼            ▼            ▼
┌───────────┐ ┌───────────┐ ┌───────────┐
│ 管理区域   │ │ 监控区域   │ │ 备份区域   │
├───────────┤ ├───────────┤ ├───────────┤
│ LDAP/AD   │ │ Prometheus│ │ 备份服务器 │
│ HSM       │ │ Grafana   │ │ 异地机房   │
│ SIEM      │ │ Alerts    │ │           │
└───────────┘ └───────────┘ └───────────┘
```

**服务器配置建议**：

| 服务器类型 | 配置 | 数量 | 用途 |
|-----------|------|------|------|
| **应用服务器** | CPU 8核 / 内存 16GB / 磁盘 200GB SSD | 6台（可扩展） | Spring Boot应用服务 |
| **数据库Master** | CPU 16核 / 内存 32GB / 磁盘 500GB SSD | 1台 | MySQL主库，处理写操作 |
| **数据库Slave** | CPU 16核 / 内存 32GB / 磁盘 500GB SSD | 2台 | MySQL从库，处理读操作 |
| **Redis Master** | CPU 4核 / 内存 16GB / 磁盘 100GB SSD | 1台 | Redis主节点 |
| **Redis Sentinel** | CPU 4核 / 内存 8GB / 磁盘 50GB SSD | 2台 | Redis哨兵节点 |
| **Nginx服务器** | CPU 4核 / 内存 8GB / 磁盘 100GB SSD | 4台 | 反向代理、负载均衡 |
| **存储服务器** | CPU 4核 / 内存 8GB / 磁盘 2TB HDD | 2台 | NFS共享存储、MinIO |
| **监控服务器** | CPU 4核 / 内存 16GB / 磁盘 200GB SSD | 3台 | Prometheus/Grafana/Alert |
| **安全服务器** | CPU 4核 / 内存 8GB / 磁盘 100GB SSD | 3台 | LDAP/HSM/SIEM |
| **备份服务器** | CPU 8核 / 内存 16GB / 磁盘 1TB SSD | 1台 | 备份与恢复 |

---

## 第十一章 系统特色

### 11.1 架构特色

#### 11.1.1 严格的DDD分层

- 清晰的依赖关系，依赖倒置原则
- 业务逻辑与技术实现彻底解耦
- 易于维护和扩展

#### 11.1.2 领域事件驱动

- 解耦业务逻辑
- 支持异步处理
- 提升系统响应速度

### 11.2 技术特色

#### 11.2.1 混合签名支持

- 支持传统算法 + 后量子算法
- 提供双重安全保障
- 平滑过渡方案

#### 11.2.2 完整审计机制

- 审计日志完整性验证（SHA-256）
- 支持审计日志追溯
- 符合合规要求

#### 11.2.3 仓储模式

- 领域接口定义
- 基础设施实现
- 易于技术栈切换

#### 11.2.4 策略模式

- 灵活的证书策略配置
- 支持多证书类型
- 易于规则扩展

### 11.3 功能特色

#### 11.3.1 定时任务

- 自动化的证书生命周期管理
- 减少人工干预
- 提升运维效率

#### 11.3.2 条件配置

- 支持多环境配置
- 支持多缓存类型
- 灵活的部署方式

#### 11.3.3 统一响应

- 标准化的API响应格式
- 统一的错误码体系
- 便于前后端协作

#### 11.3.4 国密支持

- 完整支持SM2、SM3、SM4算法
- 符合国家标准
- 适用于国产化环境

---

## 第十二章 关键技术点

### 12.1 混合签名实现

- 使用Bouncy Castle密码学库
- 支持SM2（国密）、ML-DSA（后量子）、RSA、ECDSA等算法
- 采用Catalyst模型破解签名循环依赖

### 12.2 仓储模式

- 领域层定义仓储接口
- 基础设施层实现仓储接口
- 使用MyBatis进行数据持久化

### 12.3 领域事件机制

- 聚合根发布领域事件
- 异步监听器处理事件
- 自动记录审计日志

### 12.4 审计日志完整性

- SHA-256哈希计算负载完整性
- 支持日志完整性验证
- 提供审计统计功能

---

## 第十三章 开发规范

### 13.1 编码规范

- 遵循阿里巴巴Java开发手册
- 使用Lombok简化代码
- 统一异常处理
- 统一日志规范

### 13.2 代码分层

- **Controller**：仅负责请求参数验证和响应封装
- **Service**：协调多个领域服务，不包含业务逻辑
- **Domain Service**：核心业务逻辑
- **Repository**：数据持久化

### 13.3 命名规范

- **接口**：I + 功能名 + Repository/Service/Provider
- **实现类**：接口名去掉I前缀
- **枚举**：XXXEnum（去除后缀）
- **常量**：全大写下划线分隔

---

## 第十四章 版本规划

### 14.1 当前版本 (v1.0)

- 核心证书管理功能
- 身份验证和签名功能
- 策略管理功能
- 审计日志功能
- 基础缓存功能

### 14.2 后续规划 (v2.0)

- 支持硬件安全模块（HSM）
- 支持OCSP在线证书状态协议
- 支持证书自动续期
- 支持多租户管理
- 支持图形化管理界面

---

## 附录

### 附录A 术语表

| 术语 | 全称 | 说明 |
|------|------|------|
| DDD | Domain-Driven Design | 领域驱动设计 |
| CA | Certificate Authority | 证书颁发机构 |
| CSR | Certificate Signing Request | 证书签名请求 |
| CRL | Certificate Revocation List | 证书吊销列表 |
| PKCS#10 | Public-Key Cryptography Standards | 公钥加密标准 |
| PEM | Privacy-Enhanced Mail | 隐私增强邮件格式 |
| X.509 | ITU-T X.509 | 数字证书国际标准 |
| PQC | Post-Quantum Cryptography | 后量子密码学 |
| SM2 | ShangMi 2 | 国密SM2算法 |
| ML-DSA | Module-Lattice-Based Digital Signature | 模格签名算法 |

### 附录B 参考资料

1. GB/T 35275-2017 信息安全技术 SM2密码算法使用规范
2. RFC 5280 Internet X.509 Public Key Infrastructure Certificate and CRL Profile
3. RFC 2986 PKCS #10: Certification Request Syntax Specification
4. NIST FIPS 203 Module-Lattice-Based Key-Encapsulation Mechanism Standard
5. NIST FIPS 204 Module-Lattice-Based Digital Signature Standard
6. Domain-Driven Design: Tackling Complexity in the Heart of Software (Eric Evans)
7. Implementing Domain-Driven Design (Vaughn Vernon)
8. Spring Boot Reference Documentation
9. MyBatis Reference Documentation

---

**文档修订历史**

| 版本 | 修订日期 | 修订人 | 修订内容 |
|------|---------|--------|---------|
| V1.0 | 2025-01-04 | 开发团队 | 初始版本 |

---

**文档审批**

| 角色 | 姓名 | 签名 | 日期 |
|------|------|------|------|
| 项目经理 | | | |
| 技术负责人 | | | |
| 测试负责人 | | | |

---

*本文档结束*
