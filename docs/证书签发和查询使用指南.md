# 证书签发和查询使用指南

## 系统现状

### ✅ 已实现的功能

系统**已经具备**签发和查询真实证书的能力,包括:

1. **证书生成器** (`BouncyCastleCertificateGenerator`)
   - 支持SM2、RSA(2048/4096)、ECDSA_P256等签名算法
   - 使用Bouncy Castle库生成符合标准的X.509证书
   - 支持添加CRL分发点、密钥用法等扩展

2. **CA管理** (`CertificateAuthority`)
   - 支持自签名根CA创建
   - 支持CA证书签发
   - 支持CRL生成和发布

3. **证书签发服务** (`SigningService`)
   - issueCertificate: 签发终端证书
   - generateCRL: 生成证书吊销列表

4. **完整的API接口** (`CertificateController`)
   - `POST /api/certificate/apply` - 申请证书(基于CSR)
   - `POST /api/certificate/issue` - 直接签发证书
   - `GET /api/certificate/query` - 查询证书
   - `GET /api/certificate/chain` - 查询证书链
   - `POST /api/certificate/revoke` - 吊销证书
   - `POST /api/certificate/renew` - 续期证书
   - `POST /api/certificate/status` - 查询证书状态
   - `POST /api/certificate/crl/generate` - 生成CRL

5. **数据持久化**
   - 证书信息保存到MySQL数据库
   - CRL保存到对象存储(支持MinIO和Mock)

### ⚠️ 已完成的改进

1. **CA自动初始化** - `CAInitializer`
   - 应用启动时自动检查并创建根CA
   - 使用SM2算法,10年有效期
   - CA信息自动保存到数据库

2. **Mock私钥提供者** - `MockPrivateKeyProvider`
   - 提供测试用的签名私钥
   - 支持SM2、RSA、ECDSA等多种算法
   - 生产环境可替换为HSM等安全存储

## 使用步骤

### 1. 启动应用

```bash
cd hybird
mvn clean package -DskipTests
java -jar hybird-app/target/hybird-app.jar --spring.profiles.active=dev
```

应用启动时会自动:
- 创建RootCA (如果不存在)
- 初始化Mock私钥对
- 连接数据库和Redis

### 2. 签发证书

#### 方法1: 基于CSR申请证书(推荐)

```bash
# 1. 生成密钥对
openssl ecparam -name prime256v1 -genkey -out device.key

# 2. 创建CSR
openssl req -new -key device.key -out device.csr \
  -subj "/CN=device-001/O=MyOrganization/OU=Device/C=CN"

# 3. 提交申请
curl -X POST http://localhost:8091/api/certificate/apply \
  -H "Content-Type: application/json" \
  -d '{
    "applicantId": "user001",
    "applicantName": "张三",
    "applicantEmail": "zhangsan@example.com",
    "idToken": "test-token",
    "csrPemData": "-----BEGIN CERTIFICATE REQUEST-----\n...\n-----END CERTIFICATE REQUEST-----",
    "certificateType": "DEVICE",
    "notAfter": "2026-12-31T23:59:59",
    "caName": "RootCA"
  }'
```

#### 方法2: 直接签发证书

```bash
curl -X POST http://localhost:8091/api/certificate/issue \
  -H "Content-Type: application/json" \
  -d '{
    "csrPemData": "-----BEGIN CERTIFICATE REQUEST-----\n...\n-----END CERTIFICATE REQUEST-----",
    "notBefore": "2025-01-01T00:00:00",
    "notAfter": "2026-12-31T23:59:59",
    "signatureAlgorithm": "SM2",
    "caName": "RootCA"
  }'
```

### 3. 查询证书

```bash
# 根据序列号查询
curl "http://localhost:8091/api/certificate/query?serialNumber=xxxxx"

# 查询证书链
curl "http://localhost:8091/api/certificate/chain?serialNumber=xxxxx"

# 查询设备所有证书
curl "http://localhost:8091/api/certificate/device?applicantId=user001"
```

### 4. 吊销证书

```bash
curl -X POST http://localhost:8091/api/certificate/revoke \
  -H "Content-Type: application/json" \
  -d '{
    "serialNumber": "xxxxx",
    "reasonCode": 1,
    "operator": "admin",
    "comments": "密钥泄露"
  }'
```

### 5. 查询证书状态

```bash
curl -X POST http://localhost:8091/api/certificate/status \
  -H "Content-Type: application/json" \
  -d '{
    "serialNumber": "xxxxx",
    "queryType": "single"
  }'
```

### 6. 生成CRL

```bash
curl -X POST http://localhost:8091/api/certificate/crl/generate \
  -H "Content-Type: application/json" \
  -d '{
    "caName": "RootCA",
    "signatureAlgorithm": "SM2"
  }'
```

## 响应示例

### 签发证书响应

```json
{
  "code": "0000",
  "info": "success",
  "data": {
    "serialNumber": "678a9b0c1234",
    "certificatePem": "-----BEGIN CERTIFICATE-----\nMIIC...\n-----END CERTIFICATE-----",
    "subjectDN": "CN=device-001,O=MyOrganization,C=CN",
    "issuerDN": "CN=Hybird Root CA,O=Hybird,C=CN",
    "notBefore": "2025-01-07T10:00:00",
    "notAfter": "2026-12-31T23:59:59",
    "signatureAlgorithm": "SM2withSM2",
    "crlDistributionPoint": "http://crl.example.com/ca.crl"
  }
}
```

### 查询证书响应

```json
{
  "code": "0000",
  "info": "success",
  "data": {
    "serialNumber": "678a9b0c1234",
    "certificateType": "DEVICE",
    "status": "ACTIVE",
    "subjectDN": "CN=device-001,O=MyOrganization,C=CN",
    "issuerDN": "CN=Hybird Root CA,O=Hybird,C=CN",
    "notBefore": "2025-01-07T10:00:00",
    "notAfter": "2026-12-31T23:59:59",
    "applicantId": "user001",
    "certificatePem": "-----BEGIN CERTIFICATE-----\nMIIC...\n-----END CERTIFICATE-----"
  }
}
```

## 支持的签名算法

- `SM2` - 中国国密SM2算法(推荐)
- `RSA2048` - RSA 2048位
- `RSA4096` - RSA 4096位
- `ECDSA_P256` - ECDSA with P-256曲线

## 支持的证书类型

- `DEVICE` - 设备证书
- `USER` - 用户证书
- `SERVER` - 服务器证书
- `CA` - 证书颁发机构证书
- `HYBRID` - 混合证书

## 生产环境注意事项

1. **替换私钥提供者**
   - 当前使用`MockPrivateKeyProvider`,仅用于测试
   - 生产环境应使用HSM或安全的密钥管理系统

2. **启用真实的对象存储**
   - 当前使用Mock对象存储
   - 生产环境应配置MinIO或其他对象存储服务

3. **安全配置**
   - 使用HTTPS而非HTTP
   - 配置身份验证和授权
   - 实施访问控制和审计日志

4. **CA密钥管理**
   - 生产环境的CA私钥必须安全存储
   - 考虑使用HSM硬件安全模块
   - 实施密钥轮换策略

## 总结

系统**已经完全具备**签发和查询真实证书的能力,可以:

✅ 创建根CA和中间CA
✅ 签发各种类型的终端证书
✅ 查询证书信息和状态
✅ 吊销证书并生成CRL
✅ 支持多种签名算法
✅ 完整的证书生命周期管理

只需要按照上述步骤启动应用,即可开始签发和查询证书!
