# 混合证书管理系统 - 用例图

## 一、总体用例图

```mermaid
useCaseDiagram
    actor "普通用户" as User
    actor "证书管理员" as CertAdmin
    actor "系统管理员" as SysAdmin
    actor "审计员" as Auditor

    package "证书管理子系统" {
        usecase "申请证书" as UC1
        usecase "申请混合证书" as UC2
        usecase "查询证书" as UC3
        usecase "查询证书链" as UC4
        usecase "查询设备证书" as UC5
        usecase "吊销证书" as UC6
        usecase "续期证书" as UC7
        usecase "查询证书状态" as UC8
        usecase "生成CRL" as UC9
        usecase "签发证书" as UC10
    }

    package "身份验证子系统" {
        usecase "身份验证" as UC11
    }

    package "策略管理子系统" {
        usecase "创建证书策略" as UC12
        usecase "查询策略列表" as UC13
        usecase "查询策略详情" as UC14
        usecase "激活/停用策略" as UC15
        usecase "验证CSR" as UC16
    }

    package "CA管理子系统" {
        usecase "创建CA" as UC17
        usecase "查询CA列表" as UC18
        usecase "查询CA详情" as UC19
        usecase "激活/停用CA" as UC20
        usecase "吊销CA" as UC21
    }

    package "审计子系统" {
        usecase "查询审计日志" as UC22
        usecase "查询资源审计日志" as UC23
        usecase "获取审计统计" as UC24
        usecase "验证日志完整性" as UC25
    }

    package "定时任务子系统" {
        usecase "证书过期检查" as UC26
        usecase "证书临期通知" as UC27
        usecase "CRL自动更新" as UC28
    }

    %% 普通用户用例
    User --> UC1
    User --> UC2
    User --> UC3
    User --> UC4
    User --> UC5
    User --> UC8

    %% 证书管理员用例
    CertAdmin --> UC1
    CertAdmin --> UC2
    CertAdmin --> UC3
    CertAdmin --> UC4
    CertAdmin --> UC5
    CertAdmin --> UC6
    CertAdmin --> UC7
    CertAdmin --> UC8
    CertAdmin --> UC9
    CertAdmin --> UC10
    CertAdmin --> UC11
    CertAdmin --> UC16

    %% 系统管理员用例
    SysAdmin --> UC12
    SysAdmin --> UC13
    SysAdmin --> UC14
    SysAdmin --> UC15
    SysAdmin --> UC16
    SysAdmin --> UC17
    SysAdmin --> UC18
    SysAdmin --> UC19
    SysAdmin --> UC20
    SysAdmin --> UC21
    SysAdmin --> UC26
    SysAdmin --> UC27
    SysAdmin --> UC28

    %% 审计员用例
    Auditor --> UC22
    Auditor --> UC23
    Auditor --> UC24
    Auditor --> UC25

    %% 用例关系
    UC2 ..> UC11 : <<include>>
    UC10 ..> UC11 : <<include>>
    UC9 ..> UC10 : <<extend>>
    UC6 ..> UC8 : <<extend>>
    UC7 ..> UC1 : <<extend>>
```

---

## 二、普通用户用例图

```mermaid
useCaseDiagram
    actor "普通用户" as User

    package "证书申请" {
        usecase "申请证书" as UC1
        usecase "申请混合证书" as UC2
    }

    package "证书查询" {
        usecase "查询证书" as UC3
        usecase "查询证书链" as UC4
        usecase "查询设备证书" as UC5
        usecase "查询证书状态" as UC8
    }

    User --> UC1
    User --> UC2
    User --> UC3
    User --> UC4
    User --> UC5
    User --> UC8

    UC2 ..> UC1 : <<extend>>

    note right of UC1
        用户提交CSR和身份令牌
        系统验证身份和CSR
        签发普通证书
    end note

    note right of UC2
        提交传统和后量子CSR
        生成混合签名证书
        支持SM2+ML-DSA
    end note

    note right of UC4
        查询完整的证书链
        从终端证书到根CA
        包含中间CA
    end note

    note right of UC8
        快速查询吊销状态
        基于Redis缓存
        支持批量查询
    end note
```

---

## 三、证书管理员用例图

```mermaid
useCaseDiagram
    actor "证书管理员" as CertAdmin

    package "证书管理" {
        usecase "申请证书" as UC1
        usecase "申请混合证书" as UC2
        usecase "查询证书" as UC3
        usecase "查询证书链" as UC4
        usecase "查询设备证书" as UC5
        usecase "吊销证书" as UC6
        usecase "续期证书" as UC7
        usecase "查询证书状态" as UC8
        usecase "生成CRL" as UC9
        usecase "签发证书" as UC10
    }

    package "身份验证" {
        usecase "身份验证" as UC11
    }

    package "策略验证" {
        usecase "验证CSR" as UC16
    }

    CertAdmin --> UC1
    CertAdmin --> UC2
    CertAdmin --> UC3
    CertAdmin --> UC4
    CertAdmin --> UC5
    CertAdmin --> UC6
    CertAdmin --> UC7
    CertAdmin --> UC8
    CertAdmin --> UC9
    CertAdmin --> UC10
    CertAdmin --> UC11
    CertAdmin --> UC16

    UC2 ..> UC11 : <<include>>
    UC10 ..> UC11 : <<include>>
    UC9 ..> UC10 : <<extend>>
    UC6 ..> UC8 : <<extend>>
    UC7 ..> UC1 : <<extend>>

    note right of UC6
        选择吊销原因
        密钥泄露、CA受损等
        更新吊销状态
        生成CRL
    end note

    note right of UC7
        查询临期证书
        创建新CSR
        签发新证书
        标记旧证书
    end note

    note right of UC9
        收集已吊销证书
        生成CRL列表
        CA签名
        上传到存储
    end note
```

---

## 四、系统管理员用例图

```mermaid
useCaseDiagram
    actor "系统管理员" as SysAdmin

    package "策略管理" {
        usecase "创建证书策略" as UC12
        usecase "查询策略列表" as UC13
        usecase "查询策略详情" as UC14
        usecase "激活/停用策略" as UC15
        usecase "验证CSR" as UC16
    }

    package "CA管理" {
        usecase "创建CA" as UC17
        usecase "查询CA列表" as UC18
        usecase "查询CA详情" as UC19
        usecase "激活/停用CA" as UC20
        usecase "吊销CA" as UC21
    }

    package "定时任务" {
        usecase "证书过期检查" as UC26
        usecase "证书临期通知" as UC27
        usecase "CRL自动更新" as UC28
    }

    SysAdmin --> UC12
    SysAdmin --> UC13
    SysAdmin --> UC14
    SysAdmin --> UC15
    SysAdmin --> UC16
    SysAdmin --> UC17
    SysAdmin --> UC18
    SysAdmin --> UC19
    SysAdmin --> UC20
    SysAdmin --> UC21
    SysAdmin --> UC26
    SysAdmin --> UC27
    SysAdmin --> UC28

    note right of UC12
        设置策略名称
        配置密码学规则
        设置有效期规则
        设置主题DN规则
        启用策略
    end note

    note right of UC17
        创建根CA
        创建中间CA
        设置CA DN
        选择签名算法
        生成密钥对
    end note

    note right of UC21
        吊销原因记录
        生成吊销CRL
        停止签发服务
        通知相关方
    end note

    note right of UC26
        每日01:00执行
        查询过期证书
        更新状态为EXPIRED
        记录审计日志
    end note

    note right of UC27
        每日08:00执行
        扫描临期证书
        发送通知邮件
        记录审计日志
    end note

    note right of UC28
        每日02:00执行
        查询已吊销证书
        生成CRL
        更新缓存
    end note
```

---

## 五、审计员用例图

```mermaid
useCaseDiagram
    actor "审计员" as Auditor

    package "审计查询" {
        usecase "查询审计日志" as UC22
        usecase "查询资源审计日志" as UC23
        usecase "获取审计统计" as UC24
        usecase "验证日志完整性" as UC25
    }

    Auditor --> UC22
    Auditor --> UC23
    Auditor --> UC24
    Auditor --> UC25

    note right of UC22
        按事件类型查询
        按操作者查询
        按时间范围查询
        支持分页
    end note

    note right of UC23
        查询证书操作
        查询CA操作
        查询策略操作
        按资源ID查询
    end note

    note right of UC24
        总事件数统计
        操作类型统计
        结果状态统计
        时间范围分析
    end note

    note right of UC25
        验证负载哈希
        检测篡改日志
        生成审计报告
        支持批量验证
    end note
```

---

## 六、子系统用例图

### 6.1 证书管理子系统

```mermaid
useCaseDiagram
    actor "普通用户" as User
    actor "证书管理员" as CertAdmin
    actor "定时任务" as Scheduler

    package "证书生命周期" {
        usecase "申请证书" as UC1
        usecase "申请混合证书" as UC2
        usecase "吊销证书" as UC6
        usecase "续期证书" as UC7
    }

    package "证书查询" {
        usecase "查询证书" as UC3
        usecase "查询证书链" as UC4
        usecase "查询设备证书" as UC5
        usecase "查询证书状态" as UC8
    }

    package "证书签发" {
        usecase "签发证书" as UC10
        usecase "生成CRL" as UC9
    }

    User --> UC1
    User --> UC2
    User --> UC3
    User --> UC4
    User --> UC5
    User --> UC8

    CertAdmin --> UC1
    CertAdmin --> UC2
    CertAdmin --> UC3
    CertAdmin --> UC4
    CertAdmin --> UC5
    CertAdmin --> UC6
    CertAdmin --> UC7
    CertAdmin --> UC8
    CertAdmin --> UC9
    CertAdmin --> UC10

    Scheduler --> UC6 : "自动过期"
    Scheduler --> UC9 : "定时生成"
```

### 6.2 身份验证子系统

```mermaid
useCaseDiagram
    actor "普通用户" as User
    actor "证书管理员" as CertAdmin
    actor "身份提供者" as IdP

    package "身份验证流程" {
        usecase "身份验证" as UC11
        usecase "验证ID Token" as UC11_1
        usecase "提取申请者信息" as UC11_2
        usecase "验证CSR" as UC11_3
        usecase "验证密钥算法" as UC11_4
    }

    package "外部集成" {
        usecase "调用身份提供者" as UC11_5
        usecase "解析CSR" as UC11_6
    }

    User --> UC11
    CertAdmin --> UC11
    UC11_5 ..> UC11_1 : <<include>>
    UC11_5 ..> UC11_2 : <<include>>
    UC11_6 ..> UC11_3 : <<include>>
    UC11_6 ..> UC11_4 : <<include>>

    UC11 ..> UC11_5 : <<include>>
    UC11 ..> UC11_6 : <<include>>

    note right of UC11
        步骤1: 接收CSR和ID Token
        步骤2: 验证Token有效性
        步骤3: 提取申请者信息
        步骤4: 验证CSR格式
        步骤5: 验证密钥算法
        步骤6: 返回验证结果
    end note
```

### 6.3 策略管理子系统

```mermaid
useCaseDiagram
    actor "系统管理员" as SysAdmin
    actor "证书管理员" as CertAdmin

    package "策略CRUD" {
        usecase "创建证书策略" as UC12
        usecase "查询策略列表" as UC13
        usecase "查询策略详情" as UC14
        usecase "激活/停用策略" as UC15
    }

    package "策略验证" {
        usecase "验证CSR" as UC16
        usecase "验证密码学参数" as UC16_1
        usecase "验证主题DN" as UC16_2
        usecase "验证有效期" as UC16_3
    }

    SysAdmin --> UC12
    SysAdmin --> UC13
    SysAdmin --> UC14
    SysAdmin --> UC15
    SysAdmin --> UC16
    CertAdmin --> UC16

    UC16 ..> UC16_1 : <<include>>
    UC16 ..> UC16_2 : <<include>>
    UC16 ..> UC16_3 : <<include>>

    note right of UC12
        策略ID: 自动生成
        证书类型: DEVICE_CERT/HYBRID
        策略名称: 自定义
        密码学规则:
          - 允许的签名算法
          - 允许的KEM算法
          - 最小密钥长度
          - 混合签名要求
        有效期规则:
          - 最小天数
          - 最大天数
        主题DN规则:
          - 必需属性
    end note
```

### 6.4 CA管理子系统

```mermaid
useCaseDiagram
    actor "系统管理员" as SysAdmin

    package "CA生命周期" {
        usecase "创建CA" as UC17
        usecase "激活/停用CA" as UC20
        usecase "吊销CA" as UC21
    }

    package "CA查询" {
        usecase "查询CA列表" as UC18
        usecase "查询CA详情" as UC19
    }

    SysAdmin --> UC17
    SysAdmin --> UC18
    SysAdmin --> UC19
    SysAdmin --> UC20
    SysAdmin --> UC21

    note right of UC17
        CA ID: 自动生成
        CA名称: 唯一标识
        CA DN: 主题名称
        签名算法: SM2/RSA/ECDSA
        密钥长度: 2048/4096
        有效期: 默认10年
        证书类型: 根CA/中间CA
    end note

    note right of UC21
        CA吊销原因:
        - 密钥泄露
        - CA私钥受损
        - 业务终止
        - 合规要求
    end note
```

### 6.5 审计子系统

```mermaid
useCaseDiagram
    actor "审计员" as Auditor
    actor "系统" as System

    package "审计日志" {
        usecase "记录证书签发" as UC_LOG1
        usecase "记录证书吊销" as UC_LOG2
        usecase "记录CRL生成" as UC_LOG3
        usecase "记录身份验证" as UC_LOG4
        usecase "记录CA操作" as UC_LOG5
        usecase "记录策略操作" as UC_LOG6
    }

    package "审计查询" {
        usecase "查询审计日志" as UC22
        usecase "查询资源审计日志" as UC23
        usecase "获取审计统计" as UC24
        usecase "验证日志完整性" as UC25
    }

    System --> UC_LOG1
    System --> UC_LOG2
    System --> UC_LOG3
    System --> UC_LOG4
    System --> UC_LOG5
    System --> UC_LOG6

    Auditor --> UC22
    Auditor --> UC23
    Auditor --> UC24
    Auditor --> UC25

    note right of UC22
        查询条件:
        - 事件类型
        - 操作者
        - 起始时间
        - 结束时间
        - 分页参数
    end note

    note right of UC25
        完整性验证:
        - 计算SHA-256哈希
        - 对比存储哈希
        - 标记篡改日志
        - 生成验证报告
    end note
```

---

## 七、用例详细说明

### 7.1 证书申请用例

**用例编号**: UC1
**用例名称**: 申请证书
**参与者**: 普通用户、证书管理员
**前置条件**:
- 用户已注册并获得身份令牌
- 已准备好CSR文件
- 存在有效的证书策略

**主要流程**:
1. 用户提交证书申请请求（包含CSR和ID Token）
2. 系统验证ID Token有效性
3. 系统从IDP获取申请者信息
4. 系统解析CSR并验证格式
5. 系统根据策略验证CSR参数
6. 系统签发证书
7. 系统返回证书PEM和元数据

**后置条件**: 证书成功签发并保存到数据库

**异常流程**:
- 3a. ID Token无效 → 返回身份验证失败
- 4a. CSR格式错误 → 返回CSR验证失败
- 5a. CSR不符合策略 → 返回策略验证失败
- 6a. CA不存在 → 返回CA不可用

---

### 7.2 申请混合证书用例

**用例编号**: UC2
**用例名称**: 申请混合证书
**参与者**: 普通用户、证书管理员
**前置条件**:
- 用户已准备传统CSR和后量子CSR
- 存在支持混合签名的策略

**主要流程**:
1. 用户提交混合证书申请（包含两个CSR）
2. 系统验证两个CSR的有效性
3. 系统提取两个公钥
4. 系统使用传统算法签名（如SM2）
5. 系统使用后量子算法签名（如ML-DSA）
6. 系统合并两个签名
7. 系统生成混合证书
8. 系统返回混合证书

**后置条件**: 混合证书成功签发

**异常流程**:
- 2a. 任一CSR无效 → 返回验证失败
- 4a. 传统签名失败 → 返回签名错误
- 5a. 后量子签名失败 → 返回签名错误

---

### 7.3 证书吊销用例

**用例编号**: UC6
**用例名称**: 吊销证书
**参与者**: 证书管理员
**前置条件**:
- 证书状态为ACTIVE
- 吊销原因合法

**主要流程**:
1. 管理员提交吊销请求
2. 系统验证证书存在性
3. 系统更新证书状态为REVOKED
4. 系统记录吊销信息
5. 系统发布证书吊销事件
6. 系统更新吊销状态缓存
7. 系统返回成功响应

**后置条件**: 证书已吊销

**吊销原因**:
- KEY_COMPROMISE (密钥泄露)
- CA_COMPROMISE (CA受损)
- AFFILIATION_CHANGED (隶属关系变更)
- SUPERSEDED (被替代)
- CESSATION_OF_OPERATION (停止运营)
- CERTIFICATE_HOLD (证书暂扣)

---

### 7.4 证书续期用例

**用例编号**: UC7
**用例名称**: 续期证书
**参与者**: 证书管理员
**前置条件**:
- 旧证书存在
- 旧证书状态为ACTIVE或RENEWAL_DUE
- 有新的CSR

**主要流程**:
1. 管理员提交续期请求
2. 系统查询旧证书
3. 系统标记旧证书为待续期
4. 系统签发新证书
5. 系统保存新证书
6. 系统激活新证书
7. 系统返回新证书

**后置条件**: 新证书已签发并激活

---

### 7.5 创建CA用例

**用例编号**: UC17
**用例名称**: 创建CA
**参与者**: 系统管理员
**前置条件**:
- 管理员具有CA管理权限

**主要流程**:
1. 管理员提交CA创建请求
2. 系统生成CA ID
3. 系统生成密钥对
4. 系统创建CA证书
5. 系统保存CA信息
6. 系统返回CA ID

**后置条件**: CA创建成功

**CA类型**:
- ROOT_CA: 根证书颁发机构
- INTERMEDIATE_CA: 中间证书颁发机构

---

### 7.6 验证日志完整性用例

**用例编号**: UC25
**用例名称**: 验证日志完整性
**参与者**: 审计员
**前置条件**:
- 存在审计日志

**主要流程**:
1. 审计员指定验证范围
2. 系统查询审计日志
3. 系统计算负载哈希
4. 系统对比存储哈希
5. 系统标记不一致日志
6. 系统返回验证结果

**后置条件**: 完成完整性验证

---

## 八、用例关系说明

### 8.1 Include关系（包含）

- **申请混合证书** include **身份验证**: 混合证书申请必须先完成身份验证
- **签发证书** include **身份验证**: 签发证书前必须验证申请者身份
- **验证CSR** include **验证密码学参数**: CSR验证包含密码学参数验证
- **验证CSR** include **验证主题DN**: CSR验证包含主题DN验证
- **验证CSR** include **验证有效期**: CSR验证包含有效期验证
- **查询审计日志** include **按类型查询**: 按事件类型查询审计日志
- **查询审计日志** include **按操作者查询**: 按操作者查询审计日志
- **查询审计日志** include **按时间范围查询**: 按时间范围查询审计日志

### 8.2 Extend关系（扩展）

- **生成CRL** extend **吊销证书**: 证书吊销后可以生成CRL
- **续期证书** extend **申请证书**: 续期是申请证书的特殊情况
- **吊销证书** extend **查询证书状态**: 吊销证书后会更新状态
- **申请混合证书** extend **申请证书**: 混合证书申请是普通申请的扩展

---

## 九、用例优先级

| 优先级 | 用例编号 | 用例名称 | 说明 |
|--------|---------|---------|------|
| P0 | UC1 | 申请证书 | 核心功能，必须实现 |
| P0 | UC11 | 身份验证 | 核心功能，必须实现 |
| P0 | UC3 | 查询证书 | 核心功能，必须实现 |
| P0 | UC8 | 查询证书状态 | 核心功能，必须实现 |
| P0 | UC6 | 吊销证书 | 核心功能，必须实现 |
| P1 | UC2 | 申请混合证书 | 重要功能，增强安全性 |
| P1 | UC10 | 签发证书 | 重要功能，证书管理 |
| P1 | UC9 | 生成CRL | 重要功能，吊销状态发布 |
| P1 | UC12 | 创建证书策略 | 重要功能，策略管理 |
| P1 | UC17 | 创建CA | 重要功能，CA管理 |
| P2 | UC4 | 查询证书链 | 辅助功能，证书链验证 |
| P2 | UC5 | 查询设备证书 | 辅助功能，设备管理 |
| P2 | UC7 | 续期证书 | 辅助功能，证书续期 |
| P2 | UC13-15 | 策略管理CRUD | 辅助功能，策略维护 |
| P2 | UC18-20 | CA管理CRUD | 辅助功能，CA维护 |
| P2 | UC22-24 | 审计查询 | 辅助功能，审计分析 |
| P3 | UC25 | 验证日志完整性 | 可选功能，安全增强 |
| P3 | UC26-28 | 定时任务 | 可选功能，自动化管理 |

---

## 十、使用说明

### 10.1 Mermaid图表渲染

将上述Mermaid代码复制到支持Mermaid的编辑器中即可渲染：

1. **在线渲染**: https://mermaid.live/
2. **Typora**: 直接在Markdown文件中使用
3. **GitHub/GitLab**: 直接在Markdown文件中使用
4. **VS Code**: 安装Mermaid插件
5. **IDEA**: 安装Mermaid插件

### 10.2 导出格式

支持导出为以下格式：
- SVG (矢量图)
- PNG (位图)
- PDF (文档)

### 10.3 自定义修改

可根据实际需求修改：
- 添加新的用例
- 调整用例关系
- 修改参与者
- 添加子用例
- 添加备注说明

---

**文档版本**: V1.0
**编写日期**: 2025-01-04
**适用系统**: 混合证书管理系统
