# 混合证书管理系统概要设计

**项目名称**：混合证书管理系统
**文档版本**：V1.0
**编写日期**：2025年
**密级**：内部公开

---

## 摘要

本文档是混合证书管理系统的概要设计文档，旨在为系统的开发、测试和部署提供全面的技术指导。本系统基于领域驱动设计（DDD）架构和后量子密码学技术，实现企业级数字证书的全生命周期管理。系统支持传统密码学算法（SM2、RSA、ECDSA）与后量子密码学算法（ML-DSA、ML-KEM）的混合签名，为企业提供安全、可靠、可扩展的证书管理解决方案。

本文档从系统概述、架构设计、功能设计、数据库设计、接口设计、非功能需求、部署架构等方面对系统进行了全面阐述，为后续的详细设计和开发实施奠定了基础。

**关键词**：混合证书；后量子密码学；领域驱动设计；证书管理系统；SM2算法

---

## 第一章 绪论

### 1.1 编写目的

本概要设计文档的主要目的是：

1. **指导系统开发**：为开发团队提供系统的整体架构和设计原则，确保开发过程中遵循统一的架构规范
2. **明确技术选型**：阐述系统采用的技术栈及其合理性，为技术决策提供依据
3. **规范接口设计**：定义系统对外提供的API接口规范，便于前后端协作及第三方集成
4. **支持系统测试**：为测试团队提供系统功能清单和非功能需求，指导测试用例设计
5. **指导系统部署**：描述系统的部署架构和运维要求，为生产环境部署提供参考

### 1.2 项目背景

随着量子计算技术的快速发展，传统基于大数分解和离散对数问题的公钥密码体系面临严峻挑战。为应对量子计算带来的安全威胁，国内外密码学界正在积极推进后量子密码学（Post-Quantum Cryptography，PQC）的研究和标准化工作。

在此背景下，构建一个支持传统密码学算法和后量子密码学算法的混合证书管理系统具有重要意义。该系统不仅能够满足当前企业的证书管理需求，还能为未来向全后量子密码体系过渡提供平滑过渡方案。

### 1.3 系统目标

本系统的建设目标如下：

1. **安全性目标**：支持国密SM2算法和后量子ML-DSA算法，提升证书系统的安全等级，抵御量子计算攻击
2. **可扩展性目标**：采用DDD分层架构，实现业务逻辑与技术实现的解耦，支持功能的灵活扩展
3. **高可用性目标**：通过数据库持久化和Redis缓存，保证系统7×24小时稳定运行
4. **可维护性目标**：建立完整的审计日志和证书链管理机制，便于运维监控和故障排查
5. **标准化目标**：遵循国际标准（X.509、PKCS#10、CRL）和国家标准（GB/T 35275），确保证书格式的兼容性

### 1.4 术语定义

| 术语 | 全称 | 说明 |
|------|------|------|
| DDD | Domain-Driven Design | 领域驱动设计，一种软件开发方法论 |
| CA | Certificate Authority | 证书颁发机构 |
| CSR | Certificate Signing Request | 证书签名请求 |
| CRL | Certificate Revocation List | 证书吊销列表 |
| PKCS#10 | Public-Key Cryptography Standards | 公钥加密标准，定义CSR格式 |
| PEM | Privacy-Enhanced Mail | 隐私增强邮件格式，常用于存储证书和密钥 |
| X.509 | ITU-T X.509 | 数字证书的国际标准 |
| PQC | Post-Quantum Cryptography | 后量子密码学 |
| SM2 | ShangMi 2 | 国家密码管理局颁布的公钥密码算法 |
| ML-DSA | Module-Lattice-Based Digital Signature | 基于模格的数字签名算法 |

---

## 第二章 系统概述

### 2.1 系统简介

混合证书管理系统是一个基于领域驱动设计（DDD）架构和后量子密码学技术的企业级证书管理平台。系统采用Spring Boot 3.x框架，结合Bouncy Castle密码学库，实现了证书的全生命周期管理，包括证书申请、签发、查询、吊销、续期等功能。

系统支持传统密码学算法（SM2、RSA、ECDSA）与后量子密码学算法（ML-DSA、ML-KEM）的混合签名，能够根据不同的应用场景灵活配置证书策略，满足多样化的安全需求。

### 2.2 主要功能

系统的主要功能包括：

#### 2.2.1 证书管理功能

- **证书申请**：支持普通证书和混合证书的在线申请
- **证书签发**：基于证书策略自动签发证书
- **证书查询**：提供证书详情查询和证书链查询
- **证书吊销**：支持按吊销原因吊销证书
- **证书续期**：提供证书续期服务
- **状态查询**：提供证书吊销状态的快速查询

#### 2.2.2 身份验证功能

- **身份验证**：集成第三方身份提供者（IdP），验证申请者身份
- **CSR验证**：验证证书签名请求的有效性和完整性
- **密钥算法验证**：验证密钥算法符合证书策略要求

#### 2.2.3 策略管理功能

- **策略创建**：创建自定义证书签发策略
- **策略查询**：查询策略列表和详情
- **策略激活**：激活或停用策略
- **策略验证**：根据策略验证CSR

#### 2.2.4 CA管理功能

- **CA创建**：创建根证书颁发机构和中证书颁发机构
- **CA查询**：查询CA列表和详情
- **CA激活**：激活或停用CA
- **CA吊销**：吊销CA证书

#### 2.2.5 审计功能

- **日志查询**：查询审计日志记录
- **资源审计**：查询特定资源的审计日志
- **审计统计**：获取审计统计信息

### 2.3 用户角色

系统定义了以下用户角色：

| 角色 | 职责描述 |
|------|---------|
| 系统管理员 | 负责系统配置、CA管理、策略管理、用户管理等 |
| 证书管理员 | 负责证书的签发、吊销、续期等日常管理 |
| 审计员 | 负责查询审计日志，进行安全审计 |
| 普通用户 | 提交证书申请、查询证书信息 |

---

## 第三章 系统架构设计

### 3.1 总体架构

系统采用**六层架构设计**，严格遵循DDD（领域驱动设计）分层原则，实现业务逻辑与技术实现的彻底解耦。

#### 3.1.1 架构图

```
┌─────────────────────────────────────────────────────────┐
│                    API层 (hybird-api)                    │
│              (DTO定义、统一响应格式、接口契约)              │
└─────────────────────────────────────────────────────────┘
                            ↑
┌─────────────────────────────────────────────────────────┐
│                 触发层 (hybird-trigger)                  │
│          (HTTP控制器、定时任务、领域事件监听器)            │
└─────────────────────────────────────────────────────────┘
                            ↑
┌─────────────────────────────────────────────────────────┐
│                领域层 (hybird-domain)                    │
│    (聚合根、领域服务、仓储接口、领域事件、值对象)          │
└─────────────────────────────────────────────────────────┘
                            ↑
┌─────────────────────────────────────────────────────────┐
│              基础设施层 (hybird-infrastructure)            │
│          (仓储实现、Mapper、PO、端口适配器)               │
└─────────────────────────────────────────────────────────┘
                            ↑
┌─────────────────────────────────────────────────────────┐
│                类型层 (hybird-types)                     │
│              (枚举、异常、领域事件基类)                   │
└─────────────────────────────────────────────────────────┘
                            ↑
┌─────────────────────────────────────────────────────────┐
│               应用层 (hybird-app)                         │
│          (启动类、配置类、数据初始化、依赖注入)             │
└─────────────────────────────────────────────────────────┘
```

#### 3.1.2 模块划分

系统划分为以下六个核心模块：

| 模块 | 职责 | 依赖关系 |
|------|------|---------|
| hybird-api | 定义API接口数据传输对象（DTO）和统一响应格式 | hybird-types |
| hybird-trigger | 处理HTTP请求、执行定时任务、监听领域事件 | hybird-api, hybird-types, hybird-domain, hybird-infrastructure |
| hybird-domain | 封装核心业务逻辑，定义领域模型和仓储接口 | hybird-types |
| hybird-infrastructure | 实现仓储接口，提供数据持久化和技术支撑 | hybird-domain |
| hybird-types | 定义共享类型（枚举、异常、事件） | 无依赖 |
| hybird-app | 应用启动、配置管理、数据初始化 | hybird-trigger, hybird-infrastructure |

#### 3.1.3 依赖关系图

```
hybird-app
    │
    ├─> hybird-trigger
    │       │
    │       ├─> hybird-api ──> hybird-types
    │       │
    │       ├─> hybird-domain ──> hybird-types
    │       │
    │       └─> hybird-infrastructure ──> hybird-domain ──> hybird-types
    │
    └─> hybird-infrastructure ──> hybird-domain ──> hybird-types
```

### 3.2 分层设计原则

系统严格遵循以下分层设计原则：

#### 3.2.1 依赖倒置原则

- 领域层不依赖任何外部框架，保持纯粹的业务逻辑
- 领域层定义仓储接口（Port），基础设施层实现仓储接口（Adapter）
- 高层模块不依赖低层模块，都依赖于抽象接口

#### 3.2.2 单向依赖原则

- 依赖关系只能单向，不能形成循环依赖
- 上层模块可以调用下层模块，下层模块不能调用上层模块

#### 3.2.3 开闭原则

- 对扩展开放，对修改关闭
- 新增功能时，应通过扩展而非修改现有代码实现

### 3.3 核心技术选型

#### 3.3.1 技术栈

| 分类 | 技术选型 | 版本 | 选型理由 |
|------|---------|------|---------|
| 开发语言 | Java | 17 | 生态成熟，性能优异 |
| 应用框架 | Spring Boot | 3.4.3 | 快速开发，生态丰富 |
| 密码学库 | Bouncy Castle | 1.78.1 | 支持SM2和后量子算法 |
| 持久化框架 | MyBatis | 3.x | SQL灵活，易于优化 |
| 数据库 | MySQL | 8.0 | 开源稳定，成熟可靠 |
| 缓存 | Redis | 7.x | 高性能，支持多种数据结构 |
| 构建工具 | Maven | 3.x | 标准构建工具，依赖管理 |
| 工具库 | Lombok, Guava, FastJSON | - | 简化代码，提升效率 |

#### 3.3.2 关键技术说明

##### 3.3.2.1 领域驱动设计（DDD）

DDD是一种软件开发方法论，强调以领域为中心进行软件设计。系统采用DDD的核心概念：

- **聚合根（Aggregate Root）**：数据修改的唯一入口，保证数据一致性
- **实体（Entity）**：具有唯一标识的对象
- **值对象（Value Object）**：不可变的、通过属性值判断相等的对象
- **领域服务（Domain Service）**：不属于任何聚合根的业务逻辑
- **仓储（Repository）**：管理聚合根的持久化
- **领域事件（Domain Event）**：领域内发生的重要业务事件

##### 3.3.2.2 混合签名

混合签名是指同时使用传统签名算法和后量子签名算法对同一数据进行签名。系统支持的签名算法包括：

- **传统算法**：SM2（国密）、RSA2048、RSA4096、ECDSA_P256
- **后量子算法**：ML-DSA（基于模格的数字签名算法）

混合签名的优势：
- 提供双重安全保障，抵御传统计算和量子计算攻击
- 平滑过渡，无需一次性替换整个证书体系

##### 3.3.2.3 MyBatis

MyBatis是一种优秀的持久层框架，它支持定制化SQL、存储过程以及高级映射。系统的MyBatis使用特点：

- 采用XML映射文件定义SQL语句
- 支持动态SQL和复杂查询
- 自动完成PO（持久化对象）与数据库表的映射

##### 3.3.2.4 Redis缓存

Redis是一个开源的内存数据结构存储系统，可用作数据库、缓存和消息中间件。系统的Redis使用场景：

- 缓存证书吊销状态，提升查询性能
- 缓存证书策略，减少数据库访问
- 支持缓存降级，故障时自动切换为数据库查询

---

## 第四章 领域模型设计

### 4.1 领域划分

系统划分为**6个核心业务域**，每个域包含聚合根、实体、值对象和领域服务。

#### 4.1.1 领域域划分表

| 领域 | 聚合根 | 领域服务 | 职责 |
|------|--------|---------|------|
| 身份验证域 | AuthenticationRequest | AuthenticationService | 处理身份验证请求，验证申请者身份和CSR |
| 证书生命周期域 | Certificate | CertificateLifecycleService | 管理证书签发、激活、吊销、续期、过期 |
| 签名域 | CertificateAuthority | SigningService | 执行数字签名，签发证书和CRL |
| 策略域 | CertificatePolicy | PolicyService | 定义和执行证书签发策略 |
| 证书状态查询域 | RevocationStatusCache | RevocationStatusService | 提供高性能的证书吊销状态查询 |
| 审计日志域 | AuditEvent | AuditService | 记录系统关键操作，支持完整性和追溯 |

### 4.2 核心聚合根设计

#### 4.2.1 AuthenticationRequest（身份验证请求）

**职责**：管理身份验证请求的完整生命周期

**状态流转**：PENDING_VALIDATION → VALIDATION_SUCCESSFUL / VALIDATION_FAILED

**核心属性**：

| 属性名 | 类型 | 说明 |
|--------|------|------|
| requestId | String | 请求ID，唯一标识 |
| applicant | Applicant | 申请者信息 |
| csr | CertificateSigningRequest | 证书签名请求 |
| idToken | String | 身份提供者令牌 |
| status | AuthRequestStatus | 请求状态 |
| failureReason | String | 失败原因 |
| createdAt | LocalDateTime | 创建时间 |
| validatedAt | LocalDateTime | 验证时间 |

**核心方法**：
- `startValidation()`：启动验证流程
- `completeValidation()`：验证成功
- `failValidation()`：验证失败

**领域事件**：AuthenticationCompletedEvent

#### 4.2.2 Certificate（证书）

**职责**：管理证书签发后的动态状态

**状态流转**：PENDING_ISSUANCE → ACTIVE → REVOKED / EXPIRED / RENEWAL_DUE

**核心属性**：

| 属性名 | 类型 | 说明 |
|--------|------|------|
| serialNumber | String | 证书序列号，主键 |
| certificateType | CertificateType | 证书类型 |
| certificate | Certificate | 证书数据（值对象） |
| status | CertificateStatus | 证书状态 |
| revocationInfo | RevocationInfo | 吊销信息 |
| notificationPolicy | NotificationPolicy | 通知策略 |
| renewalNoticeDays | int | 临期通知天数 |

**核心方法**：
- `activate()`：激活证书
- `revoke()`：吊销证书
- `expire()`：过期证书
- `markForRenewal()`：标记为待续期

**领域事件**：CertificateIssuedEvent、CertificateRevokedEvent、RenewalNoticeDueEvent

#### 4.2.3 CertificateAuthority（证书颁发机构）

**职责**：执行数字签名操作，签发证书和CRL

**核心属性**：

| 属性名 | 类型 | 说明 |
|--------|------|------|
| caId | String | CA ID |
| caName | String | CA名称，唯一 |
| caDN | String | CA DN |
| certificate | Certificate | CA证书 |
| privateKeyAlias | String | 私钥别名 |
| keyType | String | 密钥类型 |
| keySize | int | 密钥长度 |
| enabled | boolean | 是否启用 |

**核心方法**：
- `issueCertificate()`：签发证书
- `generateCRL()`：生成CRL
- `performSignature()`：执行混合签名

**领域事件**：CRLIssuedEvent

#### 4.2.4 CertificatePolicy（证书策略）

**职责**：定义和执行证书签发策略

**核心属性**：

| 属性名 | 类型 | 说明 |
|--------|------|------|
| policyId | String | 策略ID |
| certificateType | CertificateType | 证书类型 |
| policyName | String | 策略名称 |
| cryptographicRule | CryptographicRule | 密码学规则 |
| validityPeriodRule | ValidityPeriodRule | 有效期规则 |
| subjectDNRule | SubjectDNRule | 主题DN规则 |
| enabled | boolean | 是否启用 |

**核心方法**：
- `enable()` / `disable()`：启用/禁用策略
- `validateCryptographicParameters()`：验证密码学参数
- `validateSubjectDN()`：验证主题DN
- `validateValidityPeriod()`：验证有效期

#### 4.2.5 RevocationStatusCache（吊销状态缓存）

**职责**：提供高性能的证书吊销状态查询

**核心属性**：
- `cache`：吊销状态缓存Map
- `crlMetadata`：CRL元数据
- `lastUpdateTime`：最后更新时间

**核心方法**：
- `isRevoked()`：检查证书是否吊销
- `batchCheckRevocation()`：批量检查
- `updateFromCRL()`：从CRL更新缓存

#### 4.2.6 AuditEvent（审计事件）

**职责**：记录系统关键操作日志，支持完整性验证

**核心属性**：

| 属性名 | 类型 | 说明 |
|--------|------|------|
| logId | Long | 日志ID，自增主键 |
| eventType | String | 事件类型 |
| payload | String | 事件数据（JSON） |
| payloadHash | String | 负载哈希（SHA-256） |
| operator | String | 操作人 |
| ipAddress | String | 客户端IP |
| timestamp | TimestampValueObject | 时间戳 |

**核心方法**：
- `computePayloadHash()`：计算负载哈希值
- `verifyPayloadIntegrity()`：验证负载完整性
- `setPayloadWithHash()`：设置负载并计算哈希

### 4.3 领域事件机制

系统采用**领域事件驱动**模式实现业务解耦，当领域内发生重要业务事件时，聚合根会发布领域事件，监听器异步处理事件。

#### 4.3.1 领域事件列表

| 事件 | 触发时机 | 消费者 |
|------|---------|--------|
| AuthenticationCompletedEvent | 身份验证成功/失败 | 审计日志、证书签发 |
| CertificateIssuedEvent | 证书签发成功 | 审计日志、证书链管理 |
| CertificateRevokedEvent | 证书吊销 | 审计日志、CRL更新 |
| CRLIssuedEvent | CRL生成 | 审计日志、缓存更新 |
| RenewalNoticeDueEvent | 证书临期 | 通知服务、审计日志 |

#### 4.3.2 事件处理流程

```
聚合根发布领域事件
    ↓
Spring事件总线广播事件
    ↓
异步监听器接收事件
    ↓
监听器处理事件（记录审计日志、更新缓存等）
```

---

## 第五章 功能设计

### 5.1 证书管理功能

#### 5.1.1 功能概述

证书管理功能是系统的核心功能，提供证书申请、签发、查询、吊销、续期等全生命周期管理。

#### 5.1.2 功能清单

| 功能编号 | 功能名称 | 功能描述 |
|---------|---------|---------|
| F-01 | 申请证书 | 支持普通证书申请，包括身份验证、策略验证、证书签发 |
| F-02 | 申请混合证书 | 支持混合签名证书申请，同时使用传统和后量子算法 |
| F-03 | 查询证书 | 根据证书序列号查询证书详细信息 |
| F-04 | 查询证书链 | 查询完整的证书信任链，从根证书到终端证书 |
| F-05 | 查询设备证书 | 查询特定申请者的所有设备证书 |
| F-06 | 吊销证书 | 按吊销原因吊销证书，记录吊销信息 |
| F-07 | 续期证书 | 为临期或过期证书提供续期服务 |
| F-08 | 查询证书状态 | 快速查询证书的吊销状态 |
| F-09 | 生成CRL | 生成证书吊销列表 |

#### 5.1.3 业务流程

##### 证书申请流程

1. 用户提交证书申请请求
2. 系统验证身份提供者令牌，验证申请者身份
3. 系统解析CSR，验证签名有效性
4. 系统验证密钥算法符合证书策略要求
5. 系统根据证书策略签发证书
6. 系统保存证书到数据库
7. 系统发布证书签发事件，记录审计日志
8. 系统返回证书信息给用户

##### 证书吊销流程

1. 用户提交证书吊销请求
2. 系统验证操作权限
3. 系统查询证书，验证证书状态
4. 系统执行吊销操作，更新证书状态
5. 系统记录吊销信息（原因、操作人、时间）
6. 系统发布证书吊销事件，记录审计日志
7. 系统返回成功响应
8. 下次定时任务更新CRL，同步更新吊销状态缓存

### 5.2 身份验证功能

#### 5.2.1 功能概述

身份验证功能集成第三方身份提供者，验证申请者的身份合法性。

#### 5.2.2 功能清单

| 功能编号 | 功能名称 | 功能描述 |
|---------|---------|---------|
| F-10 | 身份验证 | 处理身份验证请求，验证IdP令牌和CSR |

#### 5.2.3 业务流程

1. 系统接收身份验证请求
2. 系统验证IdP令牌，获取申请者信息
3. 系统解析CSR，提取公钥和主题DN
4. 系统验证CSR签名有效性
5. 系统验证密钥算法符合证书策略
6. 系统创建身份验证请求记录
7. 系统发布身份验证完成事件
8. 系统返回验证结果

### 5.3 策略管理功能

#### 5.3.1 功能概述

策略管理功能用于定义和管理证书签发策略，包括密码学规则、有效期规则、主题DN规则。

#### 5.3.2 功能清单

| 功能编号 | 功能名称 | 功能描述 |
|---------|---------|---------|
| F-11 | 创建策略 | 创建自定义证书签发策略 |
| F-12 | 查询策略列表 | 查询所有证书策略 |
| F-13 | 查询策略详情 | 查询指定策略的详细信息 |
| F-14 | 激活/停用策略 | 启用或停用证书策略 |
| F-15 | 验证CSR | 根据策略验证CSR的合规性 |

### 5.4 CA管理功能

#### 5.4.1 功能概述

CA管理功能用于创建和管理证书颁发机构，包括根CA和中证书CA。

#### 5.4.2 功能清单

| 功能编号 | 功能名称 | 功能描述 |
|---------|---------|---------|
| F-16 | 创建CA | 创建证书颁发机构 |
| F-17 | 查询CA列表 | 查询所有CA |
| F-18 | 查询CA详情 | 查询指定CA的详细信息 |
| F-19 | 激活/停用CA | 启用或停用CA |
| F-20 | 吊销CA | 吊销CA证书 |

### 5.5 审计功能

#### 5.5.1 功能概述

审计功能记录系统所有关键操作，支持日志查询和统计，提供完整的审计追溯能力。

#### 5.5.2 功能清单

| 功能编号 | 功能名称 | 功能描述 |
|---------|---------|---------|
| F-21 | 查询审计日志 | 根据条件查询审计日志 |
| F-22 | 查询资源审计日志 | 查询特定资源的审计日志 |
| F-23 | 审计统计 | 获取审计统计信息 |

---

## 第六章 接口设计

### 6.1 接口概述

系统提供RESTful API接口，采用JSON格式进行数据交换，所有接口遵循统一的响应格式。

### 6.2 统一响应格式

所有接口的响应遵循以下统一格式：

```json
{
  "code": "0000",
  "info": "success",
  "data": {}
}
```

**字段说明**：

| 字段名 | 类型 | 说明 |
|--------|------|------|
| code | String | 响应码，"0000"表示成功，"9999"表示失败 |
| info | String | 响应消息 |
| data | Object | 响应数据，具体结构根据接口而定 |

### 6.3 证书管理接口

#### 6.3.1 申请证书

**接口路径**：`POST /api/certificate/apply`

**请求参数**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| requestId | String | 是 | 请求ID |
| applicantId | String | 是 | 申请者ID |
| idToken | String | 是 | 身份提供者令牌 |
| csrPemData | String | 是 | CSR PEM格式数据 |
| subjectDN | String | 是 | 主题DN |
| caName | String | 是 | CA名称 |
| signatureAlgorithm | String | 是 | 签名算法（SM2、RSA2048等） |
| notBefore | String | 是 | 生效时间（ISO 8601） |
| notAfter | String | 是 | 失效时间（ISO 8601） |
| crlDistributionPoints | String | 否 | CRL分发点 |

**响应示例**：

```json
{
  "code": "0000",
  "info": "success",
  "data": {
    "serialNumber": "123456789ABCDEF",
    "certificatePem": "-----BEGIN CERTIFICATE-----..."
  }
}
```

#### 6.3.2 申请混合证书

**接口路径**：`POST /api/certificate/apply/hybrid`

**请求参数**：在申请证书的基础上增加以下参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| primarySignatureAlgorithm | String | 是 | 主签名算法 |
| secondarySignatureAlgorithm | String | 是 | 副签名算法 |

#### 6.3.3 查询证书

**接口路径**：`GET /api/certificate/query`

**请求参数**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| serialNumber | String | 是 | 证书序列号 |

**响应示例**：

```json
{
  "code": "0000",
  "info": "success",
  "data": {
    "serialNumber": "123456789ABCDEF",
    "certificateType": "DEVICE_CERT",
    "subjectDN": "CN=device.example.com,O=Example Corp,C=CN",
    "issuerDN": "CN=Root CA,O=Example Corp,C=CN",
    "status": "ACTIVE",
    "notBefore": "2025-01-01T00:00:00",
    "notAfter": "2026-01-01T00:00:00",
    "pemEncoded": "-----BEGIN CERTIFICATE-----..."
  }
}
```

#### 6.3.4 查询证书链

**接口路径**：`GET /api/certificate/chain`

**请求参数**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| serialNumber | String | 是 | 证书序列号 |

**响应示例**：

```json
{
  "code": "0000",
  "info": "success",
  "data": {
    "serialNumber": "123456789ABCDEF",
    "chainSize": 3,
    "chain": [
      {
        "serialNumber": "ROOTCA001",
        "subjectDN": "CN=Root CA,O=Example Corp,C=CN",
        "level": 0
      },
      {
        "serialNumber": "INTERMEDIATE001",
        "subjectDN": "CN=Intermediate CA,O=Example Corp,C=CN",
        "level": 1
      },
      {
        "serialNumber": "123456789ABCDEF",
        "subjectDN": "CN=device.example.com,O=Example Corp,C=CN",
        "level": 2
      }
    ]
  }
}
```

#### 6.3.5 查询设备证书

**接口路径**：`GET /api/certificate/device`

**请求参数**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| applicantId | String | 是 | 申请者ID |

#### 6.3.6 吊销证书

**接口路径**：`POST /api/certificate/revoke`

**请求参数**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| serialNumber | String | 是 | 证书序列号 |
| revocationReason | String | 是 | 吊销原因（KEY_COMPROMISE等） |
| revokedBy | String | 是 | 吊销操作人 |
| comments | String | 否 | 吊销备注 |

#### 6.3.7 续期证书

**接口路径**：`POST /api/certificate/renew`

**请求参数**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| serialNumber | String | 是 | 证书序列号 |
| renewalDays | int | 是 | 续期天数 |

#### 6.3.8 查询证书状态

**接口路径**：`POST /api/certificate/status`

**请求参数**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| serialNumber | String | 是 | 证书序列号 |

**响应示例**：

```json
{
  "code": "0000",
  "info": "success",
  "data": {
    "serialNumber": "123456789ABCDEF",
    "revoked": false
  }
}
```

#### 6.3.9 生成CRL

**接口路径**：`POST /api/certificate/crl/generate`

**请求参数**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| caName | String | 是 | CA名称 |
| signatureAlgorithm | String | 是 | 签名算法 |

**响应示例**：

```json
{
  "code": "0000",
  "info": "success",
  "data": {
    "crlNumber": 1,
    "crlPem": "MIIC...",
    "revokedCount": 5,
    "thisUpdate": "2025-01-01T00:00:00",
    "nextUpdate": "2025-01-02T00:00:00"
  }
}
```

### 6.4 身份验证接口

#### 6.4.1 身份验证

**接口路径**：`POST /api/authentication/validate`

**请求参数**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| requestId | String | 是 | 请求ID |
| applicantId | String | 是 | 申请者ID |
| idToken | String | 是 | 身份提供者令牌 |
| csrPemData | String | 是 | CSR PEM格式数据 |

### 6.5 策略管理接口

#### 6.5.1 创建策略

**接口路径**：`POST /api/policy/create`

**请求参数**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| certificateType | String | 是 | 证书类型 |
| policyName | String | 是 | 策略名称 |
| signatureAlgorithms | List | 是 | 允许的签名算法列表 |
| kemAlgorithms | List | 否 | 允许的KEM算法列表 |
| requireHybridSignature | Boolean | 否 | 是否要求混合签名 |
| minValidityDays | int | 是 | 最小有效天数 |
| maxValidityDays | int | 是 | 最大有效天数 |
| subjectDNPattern | String | 否 | 主题DN正则表达式 |
| requiredFields | List | 否 | 必填字段列表 |

#### 6.5.2 查询策略列表

**接口路径**：`GET /api/policy/list`

#### 6.5.3 查询策略详情

**接口路径**：`GET /api/policy/{policyId}`

#### 6.5.4 激活/停用策略

**接口路径**：`POST /api/policy/{policyId}/activate`

**请求参数**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| enabled | Boolean | 是 | true启用，false停用 |

#### 6.5.5 验证CSR

**接口路径**：`POST /api/policy/validate`

**请求参数**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| policyId | String | 是 | 策略ID |
| csrPemData | String | 是 | CSR PEM格式数据 |

### 6.6 CA管理接口

#### 6.6.1 创建CA

**接口路径**：`POST /api/ca/create`

**请求参数**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| caName | String | 是 | CA名称 |
| caDN | String | 是 | CA DN |
| keyType | String | 是 | 密钥类型（EC、RSA、SM2） |
| keySize | int | 是 | 密钥长度 |

#### 6.6.2 查询CA列表

**接口路径**：`GET /api/ca/list`

#### 6.6.3 查询CA详情

**接口路径**：`GET /api/ca/{caId}`

#### 6.6.4 激活/停用CA

**接口路径**：`POST /api/ca/{caId}/activate`

**请求参数**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| enabled | Boolean | 是 | true启用，false停用 |

#### 6.6.5 吊销CA

**接口路径**：`POST /api/ca/{caId}/revoke`

### 6.7 审计接口

#### 6.7.1 查询审计日志

**接口路径**：`POST /api/audit/query`

**请求参数**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| eventType | String | 否 | 事件类型 |
| startTime | String | 否 | 开始时间（ISO 8601） |
| endTime | String | 否 | 结束时间（ISO 8601） |
| operator | String | 否 | 操作人 |
| page | int | 是 | 页码 |
| pageSize | int | 是 | 每页数量 |

#### 6.7.2 查询资源审计日志

**接口路径**：`GET /api/audit/resource/{type}/{id}`

**路径参数**：

| 参数名 | 类型 | 说明 |
|--------|------|------|
| type | String | 资源类型（certificate、policy、ca等） |
| id | String | 资源ID |

#### 6.7.3 审计统计

**接口路径**：`GET /api/audit/statistics`

**请求参数**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| startTime | String | 否 | 开始时间（ISO 8601） |
| endTime | String | 否 | 结束时间（ISO 8601） |

---

## 第七章 数据库设计

### 7.1 数据库概述

系统采用MySQL 8.0数据库，共设计7张核心业务表，支持证书的全生命周期管理和审计追溯。

### 7.2 数据库配置

**数据库地址**：49.233.215.82:3306
**数据库名称**：hybird
**用户名**：admin
**密码**：wyman1112
**字符集**：UTF-8
**时区**：Asia/Shanghai

### 7.3 核心表设计

#### 7.3.1 certificate（证书表）

**表说明**：存储证书的基本信息、状态、有效期等

**字段说明**：

| 字段名 | 类型 | 长度 | 允许空 | 主键 | 说明 |
|--------|------|------|--------|------|------|
| serial_number | VARCHAR | 64 | 否 | 是 | 证书序列号 |
| certificate_type | VARCHAR | 32 | 否 | 否 | 证书类型 |
| subject_dn | VARCHAR | 512 | 否 | 否 | 主题DN |
| issuer_dn | VARCHAR | 512 | 否 | 否 | 颁发者DN |
| status | VARCHAR | 32 | 否 | 否 | 证书状态 |
| not_before | DATETIME | - | 否 | 否 | 生效时间 |
| not_after | DATETIME | - | 否 | 否 | 失效时间 |
| applicant_id | VARCHAR | 64 | 是 | 否 | 申请者ID |
| pem_encoded | TEXT | - | 否 | 否 | 证书PEM编码 |
| revocation_reason | VARCHAR | 32 | 是 | 否 | 吊销原因 |
| revoked_by | VARCHAR | 64 | 是 | 否 | 吊销操作人 |
| revocation_comments | TEXT | - | 是 | 否 | 吊销备注 |
| renewal_notice_days | INT | - | 否 | 否 | 临期通知天数 |
| created_at | DATETIME | - | 否 | 否 | 创建时间 |
| updated_at | DATETIME | - | 否 | 否 | 更新时间 |

**索引**：

| 索引名 | 索引类型 | 索引字段 |
|--------|---------|---------|
| PRIMARY | 主键索引 | serial_number |
| idx_status | 普通索引 | status |
| idx_applicant | 普通索引 | applicant_id |
| idx_expiry | 普通索引 | not_after |

#### 7.3.2 authentication_request（身份验证请求表）

**表说明**：存储身份验证请求信息

**字段说明**：

| 字段名 | 类型 | 长度 | 允许空 | 主键 | 说明 |
|--------|------|------|--------|------|------|
| request_id | VARCHAR | 64 | 否 | 是 | 请求ID |
| applicant_id | VARCHAR | 64 | 否 | 否 | 申请者ID |
| applicant_name | VARCHAR | 128 | 否 | 否 | 申请者名称 |
| applicant_email | VARCHAR | 256 | 是 | 否 | 申请者邮箱 |
| csr_content | TEXT | - | 否 | 否 | CSR内容 |
| csr_subject_dn | VARCHAR | 512 | 否 | 否 | CSR主题DN |
| public_key_algorithm | VARCHAR | 64 | 否 | 否 | 公钥算法 |
| status | VARCHAR | 32 | 否 | 否 | 请求状态 |
| failure_reason | TEXT | - | 是 | 否 | 失败原因 |
| created_at | DATETIME | - | 否 | 否 | 创建时间 |
| validated_at | DATETIME | - | 是 | 否 | 验证时间 |

**索引**：

| 索引名 | 索引类型 | 索引字段 |
|--------|---------|---------|
| PRIMARY | 主键索引 | request_id |
| idx_status | 普通索引 | status |
| idx_applicant | 普通索引 | applicant_id |

#### 7.3.3 certificate_policy（证书策略表）

**表说明**：存储证书签发策略

**字段说明**：

| 字段名 | 类型 | 长度 | 允许空 | 主键 | 说明 |
|--------|------|------|--------|------|------|
| policy_id | VARCHAR | 64 | 否 | 是 | 策略ID |
| certificate_type | VARCHAR | 32 | 否 | 否 | 证书类型 |
| policy_name | VARCHAR | 128 | 否 | 否 | 策略名称 |
| signature_algorithms | TEXT | - | 否 | 否 | 允许的签名算法（JSON） |
| kem_algorithms | TEXT | - | 是 | 否 | 允许的KEM算法（JSON） |
| require_hybrid_signature | BOOLEAN | - | 否 | 否 | 是否要求混合签名 |
| min_validity_days | INT | - | 否 | 否 | 最小有效天数 |
| max_validity_days | INT | - | 否 | 否 | 最大有效天数 |
| subject_dn_pattern | VARCHAR | 512 | 是 | 否 | 主题DN正则表达式 |
| enabled | BOOLEAN | - | 否 | 否 | 是否启用 |
| created_at | DATETIME | - | 否 | 否 | 创建时间 |
| updated_at | DATETIME | - | 否 | 否 | 更新时间 |

**索引**：

| 索引名 | 索引类型 | 索引字段 |
|--------|---------|---------|
| PRIMARY | 主键索引 | policy_id |
| uk_name_type | 唯一索引 | policy_name, certificate_type |
| idx_type_enabled | 普通索引 | certificate_type, enabled |

#### 7.3.4 certificate_authority（CA表）

**表说明**：存储证书颁发机构信息

**字段说明**：

| 字段名 | 类型 | 长度 | 允许空 | 主键 | 说明 |
|--------|------|------|--------|------|------|
| ca_id | VARCHAR | 64 | 否 | 是 | CA ID |
| ca_name | VARCHAR | 128 | 否 | 否 | CA名称 |
| ca_dn | VARCHAR | 512 | 否 | 否 | CA DN |
| certificate_pem | TEXT | - | 否 | 否 | CA证书PEM |
| private_key_alias | VARCHAR | 64 | 否 | 否 | 私钥别名 |
| key_type | VARCHAR | 32 | 否 | 否 | 密钥类型 |
| key_size | INT | - | 否 | 否 | 密钥长度 |
| enabled | BOOLEAN | - | 否 | 否 | 是否启用 |
| created_at | DATETIME | - | 否 | 否 | 创建时间 |
| updated_at | DATETIME | - | 否 | 否 | 更新时间 |

**索引**：

| 索引名 | 索引类型 | 索引字段 |
|--------|---------|---------|
| PRIMARY | 主键索引 | ca_id |
| uk_ca_name | 唯一索引 | ca_name |

#### 7.3.5 audit_log（审计日志表）

**表说明**：存储审计日志记录

**字段说明**：

| 字段名 | 类型 | 长度 | 允许空 | 主键 | 说明 |
|--------|------|------|--------|------|------|
| log_id | BIGINT | - | 否 | 是 | 日志ID（自增） |
| event_type | VARCHAR | 64 | 否 | 否 | 事件类型 |
| event_data | TEXT | - | 否 | 否 | 事件数据（JSON） |
| payload_hash | VARCHAR | 64 | 否 | 否 | 负载哈希（SHA-256） |
| operator | VARCHAR | 64 | 是 | 否 | 操作人 |
| ip_address | VARCHAR | 45 | 是 | 否 | 客户端IP |
| created_at | DATETIME | - | 否 | 否 | 创建时间 |

**索引**：

| 索引名 | 索引类型 | 索引字段 |
|--------|---------|---------|
| PRIMARY | 主键索引 | log_id |
| idx_event_type | 普通索引 | event_type |
| idx_operator | 普通索引 | operator |
| idx_created_at | 普通索引 | created_at |

#### 7.3.6 certificate_chain（证书链表）

**表说明**：存储证书链关系

**字段说明**：

| 字段名 | 类型 | 长度 | 允许空 | 主键 | 说明 |
|--------|------|------|--------|------|------|
| chain_id | BIGINT | - | 否 | 是 | 链ID（自增） |
| certificate_serial_number | VARCHAR | 64 | 否 | 否 | 证书序列号 |
| parent_serial_number | VARCHAR | 64 | 是 | 否 | 父证书序列号 |
| level | INT | - | 否 | 否 | 层级（0为根证书） |
| created_at | DATETIME | - | 否 | 否 | 创建时间 |

**索引**：

| 索引名 | 索引类型 | 索引字段 |
|--------|---------|---------|
| PRIMARY | 主键索引 | chain_id |
| idx_serial | 普通索引 | certificate_serial_number |
| idx_parent | 普通索引 | parent_serial_number |

#### 7.3.7 revocation_status_cache（吊销状态缓存表）

**表说明**：存储吊销状态缓存数据

**字段说明**：

| 字段名 | 类型 | 长度 | 允许空 | 主键 | 说明 |
|--------|------|------|--------|------|------|
| cache_id | VARCHAR | 64 | 否 | 是 | 缓存ID |
| cache_data | TEXT | - | 否 | 否 | 缓存数据（JSON） |
| version | INT | - | 否 | 否 | 版本号 |
| is_latest | BOOLEAN | - | 否 | 否 | 是否为最新版本 |
| created_at | DATETIME | - | 否 | 否 | 创建时间 |
| updated_at | DATETIME | - | 否 | 否 | 更新时间 |

**索引**：

| 索引名 | 索引类型 | 索引字段 |
|--------|---------|---------|
| PRIMARY | 主键索引 | cache_id |
| idx_latest | 普通索引 | is_latest |

---

## 第八章 非功能需求

### 8.1 性能需求

#### 8.1.1 响应时间要求

| 指标名称 | 目标值 | 说明 |
|---------|-------|------|
| 证书查询响应时间 | ≤ 100ms | 使用Redis缓存 |
| 证书签发响应时间 | ≤ 500ms | 包含身份验证和签名 |
| 批量吊销状态查询响应时间 | ≤ 200ms | 10个证书批量查询 |
| CRL生成响应时间 | ≤ 2s | 1000个已吊销证书 |
| 审计日志查询响应时间 | ≤ 500ms | 分页查询100条记录 |

#### 8.1.2 吞吐量要求

| 指标名称 | 目标值 | 说明 |
|---------|-------|------|
| 并发用户数 | ≥ 1000 | 支持的在线用户数 |
| 证书签发TPS | ≥ 100 | 每秒证书签发数 |
| 证书查询QPS | ≥ 1000 | 每秒查询数 |
| 吊销状态查询QPS | ≥ 5000 | 使用缓存 |

#### 8.1.3 并发控制

- 使用线程池管理并发请求
- 数据库连接池最大连接数20
- Redis连接池最大连接数10
- 使用分布式锁避免并发冲突

### 8.2 安全需求

#### 8.2.1 通信安全

- 所有API通信必须使用HTTPS/TLS加密
- 支持TLS 1.2和TLS 1.3
- 客户端验证服务器证书
- 可选的客户端双向认证

#### 8.2.2 数据安全

- 私钥使用AES-256加密存储
- 证书PEM使用Base64编码存储
- IdP令牌使用JWT签名验证
- 审计日志使用SHA-256哈希保证完整性

#### 8.2.3 访问控制

- 实现基于角色的访问控制（RBAC）
- 支持IP白名单限制访问
- 记录所有关键操作的审计日志
- 敏感操作需要二次认证

#### 8.2.4 密码学要求

- 支持SM2国密算法
- 支持ML-DSA后量子算法
- 签名算法符合GB/T 35275标准
- 哈希算法使用SHA-256

### 8.3 可靠性需求

#### 8.3.1 可用性

- 系统可用性≥ 99.9%（年停机时间≤ 8.76小时）
- 支持服务的平滑升级和回滚
- 关键服务支持集群部署

#### 8.3.2 数据持久化

- 数据库采用主从复制
- 数据备份策略：每日全量备份 + 每小时增量备份
- 备份数据保留30天
- 支持数据恢复时间目标（RTO）≤ 1小时

#### 8.3.3 缓存高可用

- Redis采用哨兵模式
- 支持自动故障转移
- 缓存故障时自动降级为数据库查询

#### 8.3.4 容错机制

- 调用外部服务超时重试
- 关键操作实现幂等性
- 异步事件监听失败重试

### 8.4 可维护性需求

#### 8.4.1 日志管理

- 日志级别：ERROR、WARN、INFO、DEBUG
- 日志文件按日期滚动
- 日志保留时间：ERROR日志90天，其他日志30天
- 支持日志集中收集和分析

#### 8.4.2 监控告警

- 监控关键指标：证书数量、过期证书、错误率、响应时间
- 告警规则：证书临期、服务异常、性能下降
- 支持邮件、短信、钉钉等多种告警方式

#### 8.4.3 版本管理

- 数据库变更使用Flyway版本控制
- 支持灰度发布
- 提供回滚方案

#### 8.4.4 文档规范

- API文档使用Swagger/OpenAPI规范
- 架构文档、部署文档齐全
- 代码注释覆盖率≥ 30%

### 8.5 扩展性需求

#### 8.5.1 水平扩展

- 应用支持多实例部署
- 使用负载均衡分发请求
- 支持动态扩容

#### 8.5.2 垂直扩展

- 支持配置调整（线程池、连接池等）
- 支持JVM参数调优

#### 8.5.3 功能扩展

- 支持插件化扩展
- 提供SPI接口
- 支持自定义签名算法集成

### 8.6 兼容性需求

#### 8.6.1 浏览器兼容性

- 支持Chrome 90+
- 支持Firefox 88+
- 支持Safari 14+
- 支持Edge 90+

#### 8.6.2 操作系统兼容性

- Linux（CentOS 7+, Ubuntu 18.04+）
- Windows Server 2016+
- macOS 10.15+

#### 8.6.3 数据库兼容性

- MySQL 8.0+
- MariaDB 10.5+

#### 8.6.4 证书格式兼容性

- 支持X.509 v3证书
- 支持PKCS#10 CSR格式
- 支持CRL格式

---

## 第九章 定时任务设计

### 9.1 定时任务概述

系统设计了3个定时任务，用于自动化的证书生命周期管理和系统维护。

### 9.2 定时任务列表

| 任务编号 | 任务名称 | 执行时间 | 任务描述 |
|---------|---------|---------|---------|
| T-01 | 证书过期检查 | 每日01:00 | 检查并标记过期证书 |
| T-02 | 证书临期通知 | 每日08:00 | 扫描临期证书并发送通知 |
| T-03 | CRL更新 | 每日02:00 | 更新CRL和吊销状态缓存 |

### 9.3 证书过期检查任务

**任务名称**：CertificateExpiryCheckJob.checkExpiredCertificates()

**执行时间**：每日01:00

**任务描述**：
1. 查询所有状态为ACTIVE的证书
2. 检查证书的notAfter时间是否小于当前时间
3. 将过期证书的状态更新为EXPIRED
4. 记录过期证书的审计日志

### 9.4 证书临期通知任务

**任务名称**：CertificateExpiryCheckJob.scanExpiringCertificates()

**执行时间**：每日08:00

**任务描述**：
1. 查询所有状态为ACTIVE的证书
2. 检查证书的notAfter时间是否在临期通知天数内（默认30天）
3. 发布RenewalNoticeDueEvent事件
4. 记录临期通知的审计日志

### 9.5 CRL更新任务

**任务名称**：CRLUpdateJob.updateCRL()

**执行时间**：每日02:00

**任务描述**：
1. 查询所有启用的CA
2. 为每个CA查询所有已吊销的证书
3. 生成CRL（证书吊销列表）
4. 发布CRLIssuedEvent事件
5. 更新吊销状态缓存
6. 记录CRL生成的审计日志

---

## 第十章 缓存策略设计

### 10.1 缓存概述

系统采用Redis作为缓存服务，提升查询性能，降低数据库负载。

### 10.2 缓存配置

**Redis配置**：
- 主机：49.233.215.82
- 端口：6379
- 密码：wyman1112
- 数据库：0
- 最大连接数：10

### 10.3 缓存对象

| 缓存对象 | 缓存键 | 过期时间 | 说明 |
|---------|-------|---------|------|
| 证书吊销状态 | revocation:cache | 24小时 | 存储所有证书的吊销状态 |
| 证书策略 | policy:{policyId} | 1小时 | 存储证书策略详情 |

### 10.4 缓存更新策略

| 缓存对象 | 更新时机 | 更新方式 |
|---------|---------|---------|
| 证书吊销状态 | CRL更新时 | 全量更新 |
| 证书策略 | 策略变更时 | 单条更新 |

### 10.5 缓存降级

当Redis不可用时，系统自动降级为数据库查询：
- 监控Redis连接状态
- 连接失败时记录告警
- 所有缓存查询改为数据库查询
- Redis恢复后自动切换回缓存查询

---

## 第十一章 部署架构设计

### 11.1 部署模式

系统支持单机部署和分布式部署两种模式。

### 11.2 单机部署架构

**适用场景**：开发环境、测试环境、小规模生产环境

**架构图**：

```
┌─────────────────────────────────┐
│     应用服务器 (Spring Boot)     │
│  - HTTP服务 (端口8080)          │
│  - 定时任务                     │
│  - 事件监听器                   │
└─────────────┬───────────────────┘
              │
    ┌─────────┴─────────┐
    │                   │
┌───▼────┐        ┌────▼────┐
│ MySQL  │        │  Redis  │
│  3306  │        │  6379   │
└────────┘        └─────────┘
```

**服务器配置建议**：
- CPU：4核
- 内存：8GB
- 磁盘：100GB SSD

### 11.3 分布式部署架构

**适用场景**：大规模生产环境

**架构图**：

```
                    ┌────────────┐
                    │  负载均衡器 │
                    └──────┬─────┘
                           │
           ┌───────────────┼───────────────┐
           │               │               │
    ┌──────▼────┐   ┌──────▼────┐   ┌──────▼────┐
    │ App Node1 │   │ App Node2 │   │ App Node3 │
    │  8080     │   │  8080     │   │  8080     │
    └───────────┘   └───────────┘   └───────────┘
           │               │               │
           └───────────────┼───────────────┘
                           │
      ┌────────────────────┼────────────────────┐
      │                    │                    │
┌─────▼──────┐    ┌──────▼──────┐     ┌─────▼──────┐
│ MySQL 主从 │    │ Redis 哨兵  │     │ 文件存储   │
│ Master+Slave│   │ Sentinel    │     │ (可选)     │
└────────────┘    └─────────────┘     └────────────┘
```

**服务器配置建议**：
- 应用服务器：每台CPU 8核，内存16GB
- 数据库服务器：Master CPU 16核，内存32GB；Slave同配置
- Redis服务器：CPU 4核，内存8GB

### 11.4 部署步骤

#### 11.4.1 环境准备

1. 安装JDK 17
2. 安装MySQL 8.0
3. 安装Redis 7.x
4. 安装Maven 3.x

#### 11.4.2 数据库初始化

1. 创建数据库：
   ```sql
   CREATE DATABASE hybird DEFAULT CHARACTER SET utf8mb4;
   ```

2. 执行初始化脚本：
   ```bash
   mysql -u admin -p hybird < docs/schema.sql
   ```

#### 11.4.3 应用编译

1. 编译项目：
   ```bash
   mvn clean package -DskipTests
   ```

2. 打包后的JAR文件位于：`hybird-app/target/hybird-app-1.0.0.jar`

#### 11.4.4 应用启动

1. 配置环境变量：
   ```bash
   export SPRING_PROFILES_ACTIVE=prod
   ```

2. 启动应用：
   ```bash
   java -jar hybird-app/target/hybird-app-1.0.0.jar
   ```

3. 验证启动：
   ```bash
   curl http://localhost:8080/actuator/health
   ```

---

## 第十二章 系统特色

### 12.1 架构特色

#### 12.1.1 严格的DDD分层

- 清晰的依赖关系，依赖倒置原则
- 业务逻辑与技术实现彻底解耦
- 易于维护和扩展

#### 12.1.2 领域事件驱动

- 解耦业务逻辑
- 支持异步处理
- 提升系统响应速度

### 12.2 技术特色

#### 12.2.1 混合签名支持

- 支持传统算法 + 后量子算法
- 提供双重安全保障
- 平滑过渡方案

#### 12.2.2 完整审计机制

- 审计日志完整性验证（SHA-256）
- 支持审计日志追溯
- 符合合规要求

#### 12.2.3 仓储模式

- 领域接口定义
- 基础设施实现
- 易于技术栈切换

#### 12.2.4 策略模式

- 灵活的证书策略配置
- 支持多证书类型
- 易于规则扩展

### 12.3 功能特色

#### 12.3.1 定时任务

- 自动化的证书生命周期管理
- 减少人工干预
- 提升运维效率

#### 12.3.2 条件配置

- 支持多环境配置
- 支持多缓存类型
- 灵活的部署方式

#### 12.3.3 统一响应

- 标准化的API响应格式
- 统一的错误码体系
- 便于前后端协作

#### 12.3.4 国密支持

- 完整支持SM2、SM3、SM4算法
- 符合国家标准
- 适用于国产化环境

---

## 第十三章 风险与对策

### 13.1 技术风险

| 风险项 | 风险等级 | 应对措施 |
|--------|---------|---------|
| 后量子算法不成熟 | 中 | 持续跟踪NIST标准更新，预留接口支持算法切换 |
| Redis单点故障 | 中 | 采用哨兵模式，实现自动故障转移 |
| 数据库性能瓶颈 | 中 | 采用读写分离，优化索引，考虑分库分表 |
| 密钥泄露风险 | 高 | 使用HSM存储私钥，定期轮换密钥 |

### 13.2 业务风险

| 风险项 | 风险等级 | 应对措施 |
|--------|---------|---------|
| 证书大规模过期 | 高 | 实现临期通知机制，支持批量续期 |
| 证书误吊销 | 中 | 实现二次确认，支持证书恢复（可选） |
| 策略配置错误 | 中 | 提供策略验证接口，支持沙盒测试 |
| 审计日志被篡改 | 中 | 使用SHA-256哈希保证完整性，定期备份 |

### 13.3 运维风险

| 风险项 | 风险等级 | 应对措施 |
|--------|---------|---------|
| 系统升级失败 | 中 | 实现灰度发布，提供回滚方案 |
| 数据备份丢失 | 高 | 多副本备份，异地容灾 |
| 监控告警缺失 | 中 | 建立完善的监控体系，设置合理告警阈值 |
| 权限管理不当 | 高 | 实施最小权限原则，定期审计权限 |

---

## 第十四章 总结与展望

### 14.1 总结

本文档对混合证书管理系统的概要设计进行了全面阐述，从系统概述、架构设计、功能设计、数据库设计、接口设计、非功能需求等方面进行了详细说明。

系统采用领域驱动设计（DDD）架构，严格遵循分层原则，实现了业务逻辑与技术实现的彻底解耦。系统支持传统密码学算法（SM2、RSA、ECDSA）与后量子密码学算法（ML-DSA、ML-KEM）的混合签名，为企业提供安全、可靠、可扩展的证书管理解决方案。

系统的主要特点包括：

1. **架构清晰**：六层架构设计，依赖关系明确
2. **技术先进**：支持国密和后量子算法
3. **功能完整**：覆盖证书全生命周期管理
4. **性能优异**：使用Redis缓存，响应速度快
5. **安全可靠**：完整的审计机制，符合合规要求

### 14.2 展望

随着量子计算技术的不断发展和后量子密码学标准的不断完善，系统将在以下方面持续优化：

1. **后量子算法演进**：持续跟踪NIST和国内后量子密码学标准的进展，及时更新算法实现
2. **性能优化**：进一步优化系统性能，提升证书签发和查询效率
3. **功能扩展**：增加OCSP在线证书状态协议、证书自动续期等功能
4. **用户体验**：提供图形化管理界面，提升易用性
5. **国产化适配**：适配国产操作系统、数据库、中间件

---

## 附录

### 附录A 代码统计

| 模块 | Java文件数 | 代码行数（估算） |
|------|-----------|----------------|
| hybird-domain | 35 | ~5000 |
| hybird-app | 13 | ~1000 |
| hybird-infrastructure | 30 | ~4000 |
| hybird-trigger | 8 | ~2000 |
| hybird-types | 16 | ~500 |
| hybird-api | 24 | ~800 |
| **总计** | **126** | **~13300** |

### 附录B 参考资料

1. GB/T 35275-2017 信息安全技术 SM2密码算法使用规范
2. RFC 5280 Internet X.509 Public Key Infrastructure Certificate and CRL Profile
3. RFC 2986 PKCS #10: Certification Request Syntax Specification
4. NIST FIPS 203 Module-Lattice-Based Key-Encapsulation Mechanism Standard
5. NIST FIPS 204 Module-Lattice-Based Digital Signature Standard
6. Domain-Driven Design: Tackling Complexity in the Heart of Software (Eric Evans)
7. Implementing Domain-Driven Design (Vaughn Vernon)
8. Spring Boot Reference Documentation
9. MyBatis Reference Documentation

### 附录C 术语索引

- **A**
  - API：应用程序接口
  - AppException：应用异常
  - AuditEvent：审计事件
  - AuthenticationRequest：身份验证请求
  - AppException：应用异常

- **C**
  - CA：证书颁发机构
  - Certificate：证书
  - CertificateAuthority：证书颁发机构（聚合根）
  - CertificateChain：证书链
  - CertificateLifecycleService：证书生命周期服务
  - CertificatePolicy：证书策略
  - CSR：证书签名请求
  - CRL：证书吊销列表

- **D**
  - DDD：领域驱动设计
  - DTO：数据传输对象

- **H**
  - HTTP：超文本传输协议
  - HTTPS：安全的超文本传输协议

- **I**
  - IdP：身份提供者

- **J**
  - JWT：JSON Web Token

- **M**
  - ML-DSA：基于模格的数字签名算法
  - ML-KEM：基于模格的密钥封装机制

- **O**
  - OCSP：在线证书状态协议

- **P**
  - PQC：后量子密码学
  - PEM：隐私增强邮件格式
  - PKCS#10：公钥加密标准第10号

- **R**
  - Redis：远程字典服务器
  - REST：表述性状态传递
  - RevocationStatusCache：吊销状态缓存

- **S**
  - SM2：国密SM2算法
  - SM3：国密SM3算法
  - SM4：国密SM4算法
  - SSL：安全套接层

- **X**
  - X.509：数字证书国际标准

---

**文档修订历史**

| 版本 | 修订日期 | 修订人 | 修订内容 |
|------|---------|--------|---------|
| V1.0 | 2025-01-04 | 开发团队 | 初始版本 |

---

**文档审批**

| 角色 | 姓名 | 签名 | 日期 |
|------|------|------|------|
| 项目经理 | | | |
| 技术负责人 | | | |
| 测试负责人 | | | |

---

*本文档结束*
