### 混合证书签发指南（经典 + PQC 双签 / 双公钥）

- **目标**: 使用现有系统的 `/api/certificate/apply/hybrid` 接口，签发同时包含经典公钥、PQC 签名公钥、PQC KEM 公钥，并带有备用签名（Catalyst 双签）的混合证书。
- **核心流程**: 经典 CSR + PQC CSR -> 双阶段构建 TBS -> PQC/备用私钥计算 `id-ce-altSignatureValue` -> 经典私钥完成最终签名。

### 前置准备
- **环境**: 已部署当前服务，确保数据库已添加列 `post_quantum_kek_public_key_pem`（见 `docs/schema.sql`）。
- **密钥**: CA 持有经典签名私钥与 PQC/备用签名私钥（系统默认占位为 RSA，可替换为真实 PQC/HSM）。
- **策略**: 证书策略需开启 `requiresHybridSignature()`，并允许所选 `signatureAlgorithm`、`kemAlgorithm` 组合。

### CSR 要求
- **经典 CSR**: 标准 PKCS#10，算法为请求中的经典签名算法，`Subject DN` 与 PQC CSR 必须一致。
- **PQC CSR**: 在 CSR Attribute 中携带以下自定义 OID（见 `HybridCertificateOids`）：
  - **签名公钥** `1.3.6.1.4.1.56546.500.2.1` (`ATTR_PQC_SIGNATURE_PUBLIC_KEY_INFO`)
  - **签名 PoP** `1.3.6.1.4.1.56546.500.2.2` (`ATTR_PQC_SIGNATURE_VALUE`)
  - **KEM 公钥** `1.3.6.1.4.1.56546.500.2.3` (`ATTR_PQC_KEK_PUBLIC_KEY_INFO`)
  - **KEM PoP** `1.3.6.1.4.1.56546.500.2.4` (`ATTR_PQC_KEK_POP_PROOF`)
- **内容格式**: 公钥建议用 PEM/Base64 字符串；PoP/Proof 为申请方用对应私钥生成的签名/证明原文，可自定义，后续策略或网关可校验。

### 请求接口
- **方法/路径**: `POST /api/certificate/apply/hybrid`
- **Content-Type**: `application/json`
- **请求体字段**（见 `HybridCertificateApplyRequest`）：
  - **applicantId**: 申请者 ID（必填）
  - **applicantName** / **applicantEmail**: 申请者信息
  - **idToken**: 身份令牌（必填）
  - **classicalCsrPemData**: 经典 CSR PEM（必填）
  - **postQuantumCsrPemData**: PQC CSR PEM（必填）
  - **signatureAlgorithm**: 经典签名算法（如 `SHA256withRSA`, `SM2`, `ECDSA_P256`，必填）
  - **kemAlgorithm**: 密钥封装算法标识（必填，与策略匹配）
  - **notAfter**: 证书失效时间（ISO-8601，必填）
  - **caName**: 目标 CA 名称（必填）

```bash
curl -X POST http://localhost:8080/api/certificate/apply/hybrid \
  -H "Content-Type: application/json" \
  -d '{
    "applicantId": "device-123",
    "applicantName": "IoT-Device-123",
    "applicantEmail": "ops@example.com",
    "idToken": "<idp-token>",
    "classicalCsrPemData": "-----BEGIN CERTIFICATE REQUEST-----\n...\n-----END CERTIFICATE REQUEST-----",
    "postQuantumCsrPemData": "-----BEGIN CERTIFICATE REQUEST-----\n...\n-----END CERTIFICATE REQUEST-----",
    "signatureAlgorithm": "SHA256withRSA",
    "kemAlgorithm": "KYBER",
    "notAfter": "2026-12-31T23:59:59",
    "caName": "root-ca"
  }'
```

### 服务端关键校验与构建
- 校验两份 CSR 签名，并要求 `Subject DN` 一致；验证策略（算法组合、有效期、DN 规则）。
- 解析 PQC 公钥/KEM 公钥/PoP 并放入 `HybridCertificateRequestContext`。
- **双阶段签名**：
  - 阶段一：构建不含 `id-ce-altSignatureValue` 的 TBS 模板，包含 PQC 公钥、KEM 公钥、备用签名算法扩展；用 PQC/备用私钥对模板 DER 做签名得到备用签名值。
  - 阶段二：将备用签名值写入 `id-ce-altSignatureValue` 扩展，重建最终 tbsCertificate，用经典私钥完成最终签名。
- 证书中扩展：
  - `1.3.6.1.4.1.56546.500.1.1` PQC 签名公钥
  - `1.3.6.1.4.1.56546.500.1.2` PQC KEM 公钥
  - `1.3.6.1.4.1.56546.500.1.3` 备用签名算法
  - `1.3.6.1.4.1.56546.500.1.4` 备用签名值

### 响应
- 成功返回 `CertificateIssuanceResponse`：`serialNumber`、`certificatePem`、`subjectDN`、`issuerDN`、`notBefore`、`notAfter`、`signatureAlgorithm`、`crlDistributionPoint`。
- 系统会在存储层保存经典证书 PEM、PQC CSR、PQC 签名公钥、PQC KEM 公钥，便于后续查询或分发。

### 验证与故障排查
- 使用 OpenSSL/BC 验证经典签名：`openssl verify -CAfile <ca.pem> <cert.pem>`。
- 解析证书扩展，确认 PQC/KEM 公钥与备用签名扩展存在；若缺失，多半是 CSR 未携带相应 OID 或策略未开启混合签名。
- 若返回 "签名/密钥封装算法不符合策略要求"，检查 `signatureAlgorithm` 与 `kemAlgorithm` 是否与策略匹配。
- 若返回 "两份CSR的Subject DN不一致"，确保两份 CSR 的 DN 完全一致（含空格/顺序）。
