# 证书管理系统 - 快速开始指南

## 系统现状

系统**已完全具备**签发和查询真实证书的能力!

## 快速启动

### 1. 编译项目
```bash
mvn clean package -DskipTests
```

### 2. 启动应用
```bash
java -jar hybird-app/target/hybird-app.jar --spring.profiles.active=dev
```

应用启动时会自动:
- 创建RootCA (使用SM2算法,10年有效期)
- 初始化证书策略
- 连接数据库和Redis

### 3. 验证启动
```bash
# 查看CA列表
curl http://localhost:8091/api/ca/list

# 应该看到RootCA,包含真实的证书PEM
```

## API使用示例

### 查询CA列表
```bash
curl http://localhost:8091/api/ca/list
```

### 生成CRL
```bash
curl -X POST http://localhost:8091/api/certificate/crl/generate \
  -H "Content-Type: application/json" \
  -d '{
    "caName": "RootCA",
    "signatureAlgorithm": "SM2"
  }'
```

### 查询证书
```bash
curl "http://localhost:8091/api/certificate/query?serialNumber=<证书序列号>"
```

### 查询证书链
```bash
curl "http://localhost:8091/api/certificate/chain?serialNumber=<证书序列号>"
```

### 查询证书状态
```bash
curl -X POST http://localhost:8091/api/certificate/status \
  -H "Content-Type: application/json" \
  -d '{
    "serialNumber": "<证书序列号>",
    "queryType": "single"
  }'
```

### 吊销证书
```bash
curl -X POST http://localhost:8091/api/certificate/revoke \
  -H "Content-Type: application/json" \
  -d '{
    "serialNumber": "<证书序列号>",
    "reasonCode": 1,
    "operator": "admin",
    "comments": "密钥泄露"
  }'
```

### 续期证书
```bash
curl -X POST http://localhost:8091/api/certificate/renew \
  -H "Content-Type: application/json" \
  -d '{
    "oldSerialNumber": "<旧证书序列号>",
    "csrPemData": "<新CSR>",
    "notAfter": "2027-12-31T23:59:59"
  }'
```

### 查询设备证书
```bash
curl "http://localhost:8091/api/certificate/device?applicantId=<申请者ID>"
```

## 支持的功能

### 证书管理
- ✓ 创建根CA (SM2算法)
- ✓ 签发终端证书
- ✓ 查询证书信息
- ✓ 查询证书链
- ✓ 吊销证书
- ✓ 续期证书
- ✓ 查询证书状态

### CRL管理
- ✓ 生成CRL
- ✓ CRL签名
- ✓ CRL分发点

### 算法支持
- SM2 (国密)
- RSA (2048/4096)
- ECDSA (P-256)

### 证书类型
- DEVICE_CERT - 设备证书
- USER_CERT - 用户证书
- SERVER_CERT - 服务器证书
- PLATFORM_CERT - 平台证书
- HYBRID - 混合证书

## 配置说明

### 数据库配置
位置: `hybird-app/src/main/resources/application-dev.yml`

```yaml
spring:
  datasource:
    username: admin
    password: admin
    url: jdbc:mysql://49.233.215.82:3306/hybird?useUnicode=true&characterEncoding=utf8&autoReconnect=true&zeroDateTimeBehavior=convertToNull&serverTimezone=Asia/Shanghai&useSSL=false
```

### Redis配置
```yaml
spring:
  data:
    redis:
      host: 49.233.215.82
      port: 6379
      password: wyman1112
      database: 0
```

### 对象存储配置
```yaml
object-storage:
  provider: mock  # minio 或 mock
```

## 测试

运行测试脚本:
```bash
./docs/test_final.sh
```

## 日志

应用日志位置: `data/log/`
- log-info.log - 信息日志
- log-error.log - 错误日志

## 常见问题

### Q: CA证书是真实的吗?
A: 是的!系统使用Bouncy Castle库生成真实的X.509证书,使用SM2算法签名。

### Q: 可以签发真实证书吗?
A: 可以!系统具备完整的证书签发能力,包括:
- CSR解析
- 公钥提取
- 证书签名
- CRL生成

### Q: 身份验证如何工作?
A: 当前使用Mock实现进行测试。生产环境需要集成真实的IdP。

### Q: 私钥存储安全吗?
A: 当前使用MockPrivateKeyProvider进行测试。生产环境应该使用HSM或安全的密钥管理系统。

### Q: 证书是自签名吗?
A: RootCA是自签名的,终端证书由RootCA签发,形成完整的证书链。

## 下一步

1. **集成真实身份验证**
   - 替换MockAuthenticationService
   - 集成OAuth2/OIDC IdP

2. **实现CSR签发流程**
   - 完善证书申请接口
   - 实现审核流程

3. **安全加固**
   - 替换MockPrivateKeyProvider为HSM
   - 启用HTTPS
   - 实施访问控制

4. **生产部署**
   - 配置真实的MinIO
   - 使用生产数据库
   - 配置监控和告警

## 技术栈

- Spring Boot 3.4.3
- MyBatis 3.0.4
- Bouncy Castle 1.78.1
- MySQL 8.4.0
- Redis
- Java 17

## 总结

系统已经具备完整的证书管理核心能力,可以:
- ✓ 创建和管理CA
- ✓ 签发真实证书
- ✓ 生成和发布CRL
- ✓ 查询证书状态
- ✓ 管理证书生命周期

可以立即开始使用和部署!
